<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Leady</title>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f4f4;
    }
    h1 { margin-bottom: 20px; }
    .filters {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        background: #fff;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #ddd;
    }
    input, select {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #aaa;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }
    th, td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
    }
    th { background: #eee; cursor: pointer; }
</style>
</head>
<body>

<h1>Leady z Google Sheets</h1>

<div class="filters">
    <div>
        <label>Data od:</label><br>
        <input type="date" id="dateFrom">
    </div>

    <div>
        <label>Data do:</label><br>
        <input type="date" id="dateTo">
    </div>

    <div>
        <label>Sortowanie:</label><br>
        <select id="sortOrder">
            <option value="newest">Od najnowszych</option>
            <option value="oldest">Od najstarszych</option>
        </select>
    </div>

    <div>
        <label>Kampania:</label><br>
        <select id="campaignFilter">
            <option value="">Wszystkie</option>
        </select>
    </div>

    <div>
        <label>Status:</label><br>
        <select id="statusFilter">
            <option value="">Wszystkie</option>
            <option value="Nowy">Nowy</option>
            <option value="Lead odrzucony">Lead odrzucony</option>
            <option value="Nie odbiera">Nie odbiera</option>
            <option value="Wizyta umówiona">Wizyta umówiona</option>
            <option value="Porzucony">Porzucony</option>
        </select>
    </div>
</div>

<table id="leadsTable">
    <thead>
        <tr>
            <th>Data dodania</th>
            <th>Imię</th>
            <th>Telefon</th>
            <th>Kampania</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1WubNwZuof8s8Udg93k0C9Qgo-VkPXiQT0_7-VeEg81k/edit?usp=sharing";

// ----------------------
// Pobieranie danych
// ----------------------
async function fetchLeads() {
    const res = await fetch(SHEET_URL);
    const text = await res.text();

    const rows = text.split("\n").map(r => r.split(","));
    const headers = rows.shift(); 

    return rows.map(r => ({
        date: r[0],
        name: r[1],
        phone: r[2],
        campaign: r[3],
        status: r[4]
    }));
}

// ----------------------
// Filtry i sortowanie
// ----------------------
function applyFilters(leads) {
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;
    const sortOrder = document.getElementById("sortOrder").value;
    const campaign = document.getElementById("campaignFilter").value;
    const status = document.getElementById("statusFilter").value;

    let filtered = leads;

    // Filtr: kampania
    if (campaign) {
        filtered = filtered.filter(l => l.campaign === campaign);
    }

    // Filtr: status
    if (status) {
        filtered = filtered.filter(l => l.status === status);
    }

    // Filtr zakresu dat
    if (dateFrom) {
        filtered = filtered.filter(l => new Date(l.date) >= new Date(dateFrom));
    }
    if (dateTo) {
        filtered = filtered.filter(l => new Date(l.date) <= new Date(dateTo));
    }

    // Sortowanie
    filtered.sort((a, b) => {
        if (sortOrder === "newest") {
            return new Date(b.date) - new Date(a.date);
        } else {
            return new Date(a.date) - new Date(b.date);
        }
    });

    return filtered;
}

// ----------------------
// Renderowanie tabeli
// ----------------------
function renderTable(leads) {
    const tbody = document.querySelector("#leadsTable tbody");
    tbody.innerHTML = "";

    leads.forEach(l => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${l.date}</td>
            <td>${l.name}</td>
            <td>${l.phone}</td>
            <td>${l.campaign}</td>
            <td>${l.status}</td>
        `;
        tbody.appendChild(row);
    });
}

// ----------------------
// Dynamiczne kampanie
// ----------------------
function fillCampaignFilter(leads) {
    const select = document.getElementById("campaignFilter");
    const campaigns = [...new Set(leads.map(l => l.campaign))];

    campaigns.forEach(c => {
        if (c.trim() === "") return;
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
    });
}

// ----------------------
// Główny start
// ----------------------
let allLeads = [];

async function init() {
    allLeads = await fetchLeads();
    fillCampaignFilter(allLeads);
    renderTable(allLeads);
}

init();

// reagowanie na zmiany filtrów
document.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("change", () => {
        const filtered = applyFilters(allLeads);
        renderTable(filtered);
    });
});
</script>

</body>
</html>
