<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard lead√≥w ‚Äî Firma1</title>
<style>
  :root{
    --bg:#f4f7fa; --card:#fff; --muted:#6c757d; --accent-start:#00bcd4; --accent-end:#9c27b0;
  }
  body{font-family:"Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);margin:0;padding:12px;box-sizing:border-box;color:#222}
  .wrap{max-width:1100px;margin:12px auto}
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06);overflow:hidden}
  header{background:linear-gradient(135deg,var(--accent-start),var(--accent-end));color:#fff;padding:16px;text-align:center}
  header h1{margin:0;font-size:18px}
  .controls{display:flex;gap:10px;padding:12px;flex-wrap:wrap;align-items:center}
  .controls .search{flex:1;min-width:200px}
  input[type="text"], input[type="date"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf2;background:#fff;box-sizing:border-box}
  .stats{display:flex;gap:12px;padding:12px;flex-wrap:wrap}
  .stat{flex:1 1 30%;background:#f0faff;border-left:4px solid var(--accent-start);padding:12px;border-radius:8px;font-weight:700;text-align:center}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #eef2f5;text-align:left;vertical-align:middle}
  th{background:#fafcff;font-weight:700}
  .status{padding:6px 8px;border-radius:8px;color:#fff;font-weight:700;font-size:13px;display:inline-block}
  .s-nowy{background:#9c27b0}
  .s-w_kontakcie{background:#2196f3}
  .s-odebral{background:#4caf50}
  .s-wizyta_umowiona{background:#009688}
  .s-nie_odebral{background:#ff9800}
  .s-odrzucony{background:#f44336}
  .s-porzucony{background:#607d8b}
  .s-default{background:#6c757d}
  .small{font-size:13px;color:var(--muted)}
  .table-wrap{overflow:auto}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>üìä Dashboard lead√≥w ‚Äî Firma1</h1>
      </header>

      <div style="padding:12px;">

        <div class="controls">
          <div style="flex:1;min-width:200px">
            <input id="search" class="search" type="text" placeholder="Szukaj: imiƒô, telefon, email..." />
          </div>

          <div style="width:180px">
            <select id="statusFilter">
              <option value="">‚Äî Status ‚Äî</option>
              <option value="nowy">Nowy</option>
              <option value="odrzucony">Lead odrzucony</option>
              <option value="nie_odebral">Nie odbiera</option>
              <option value="wizyta_umowiona">Wizyta um√≥wiona</option>
              <option value="porzucony">Porzucony</option>
            </select>
          </div>

          <div style="width:180px">
            <select id="campaignFilter">
              <option value="">‚Äî Kampania ‚Äî</option>
            </select>
          </div>

          <div style="width:160px">
            <input type="date" id="dateFrom">
          </div>

          <div style="width:160px">
            <input type="date" id="dateTo">
          </div>

          <div style="width:140px">
            <select id="sortOrder">
              <option value="desc">Najnowsze</option>
              <option value="asc">Najstarsze</option>
            </select>
          </div>

          <div style="width:120px">
            <select id="refreshInterval">
              <option value="60">Od≈õwie≈º co 60s</option>
              <option value="0">Wy≈ÇƒÖcz auto</option>
            </select>
          </div>
        </div>

        <div class="stats" id="stats" style="display:none">
          <div class="stat">Nowe: <span id="stat-nowe">0</span></div>
          <div class="stat">Um√≥wione / Obs≈Çu≈ºone: <span id="stat-done">0</span></div>
          <div class="stat">Nieodebrane / Porzucone: <span id="stat-bad">0</span></div>
        </div>

        <div class="table-wrap" style="padding:12px;">
          <div id="loading" class="small">≈Åadowanie danych z Google Sheets‚Ä¶</div>
          <table id="leadsTable" style="display:none">
            <thead>
              <tr>
                <th>ID</th>
                <th>Data zg≈Çoszenia</th>
                <th>Pacjent</th>
                <th>Telefon</th>
                <th>Email</th>
                <th>Cel wizyty</th>
                <th>Status</th>
                <th>Data aktualizacji</th>
                <th>Czas reakcji</th>
                <th>Kampania</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID = "1WubNwZuof8s8Udg93k0C9Qgo-VkPXiQT0_7-VeEg81k";
const SHEET_NAME = "Firma1";
const GVIZ_URL =
 `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

let allRows = [];

const tableBody = document.querySelector('#leadsTable tbody');
const loadingEl = document.getElementById('loading');

const searchInput = document.getElementById('search');
const statusFilter = document.getElementById('statusFilter');
const campaignFilter = document.getElementById('campaignFilter');
const dateFrom = document.getElementById('dateFrom');
const dateTo = document.getElementById('dateTo');
const sortOrder = document.getElementById('sortOrder');

/* DATE PARSER */
function parseGvizResponseText(text){
  const jsonText = text.replace(/^[^\(]*\(/, '').replace(/\);?$/,'');
  return JSON.parse(jsonText);
}

/* DATE FROM GOOGLE */
function parseGvizDateCell(cell){
  if (!cell) return null;
  if (cell.f){
    const d = new Date(cell.f);
    if (!isNaN(d)) return d;
  }
  const v = cell.v;
  if (typeof v === "string"){
    const m = v.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
    if (m){
      return new Date(+m[1],+m[2],+m[3],+m[4],+m[5],+m[6]);
    }
    const d = new Date(v);
    if (!isNaN(d)) return d;
  }
  if (typeof v === "number") return new Date(v);
  return null;
}

function fmtDate(d){
  if (!d) return "";
  const p = n => String(n).padStart(2,"0");
  return `${p(d.getDate())}.${p(d.getMonth()+1)}.${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
}

function statusClassFor(s){
  s = (s||"").toLowerCase();
  if (s.includes("porzu")) return "s-porzucony";
  if (s.includes("odrz")) return "s-odrzucony";
  if (s.includes("nie") && s.includes("odb")) return "s-nie_odebral";
  if (s.includes("wizyta")) return "s-wizyta_umowiona";
  if (s.includes("odebr")) return "s-odebral";
  if (s.includes("kontak")) return "s-w_kontakcie";
  if (s.includes("now")) return "s-nowy";
  return "s-default";
}

/* FILTER + RENDER */
function renderRows(){
  tableBody.innerHTML = "";

  let rows = [...allRows];

  // Search
  const q = searchInput.value.toLowerCase().trim();
  if (q){
    rows = rows.filter(r =>
      (r.name+r.phone+r.email+r.cel).toLowerCase().includes(q)
    );
  }

  // Status
  const s = statusFilter.value;
  if (s){
    rows = rows.filter(r => statusClassFor(r.statusRaw).includes(s));
  }

  // Campaign
  const c = campaignFilter.value;
  if (c){
    rows = rows.filter(r => r.campaign === c);
  }

  // Date range
  const df = dateFrom.value ? new Date(dateFrom.value) : null;
  const dt = dateTo.value ? new Date(dateTo.value+" 23:59:59") : null;
  if (df) rows = rows.filter(r => r.createdDate >= df);
  if (dt) rows = rows.filter(r => r.createdDate <= dt);

  // Sorting
  rows.sort((a,b)=>{
    if (sortOrder.value === "asc") return a.createdDate - b.createdDate;
    return b.createdDate - a.createdDate;
  });

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.createdText}</td>
      <td>${r.name}</td>
      <td>${r.phone}</td>
      <td>${r.email}</td>
      <td>${r.cel}</td>
      <td><span class="status ${statusClassFor(r.statusRaw)}">${r.statusRaw}</span></td>
      <td>${r.updatedText}</td>
      <td>${r.reaction}</td>
      <td>${r.campaign}</td>
    `;
    tableBody.appendChild(tr);
  });

  document.getElementById("leadsTable").style.display = rows.length ? "table" : "none";
}

/* LOAD SHEET */
function loadSheet(){
  fetch(GVIZ_URL).then(r=>r.text()).then(t=>{
    const json = parseGvizResponseText(t);
    const rows = json.table.rows || [];

    allRows = rows.map(r=>{
      const c = r.c;

      const createdDate = parseGvizDateCell(c[1]);
      const updatedDate = parseGvizDateCell(c[8]);

      return {
        id: c[0]?.v || "",
        createdDate,
        createdText: createdDate ? fmtDate(createdDate) : "",
        name: c[2]?.v || "",
        phone: c[3]?.v || "",
        email: c[4]?.v || "",
        cel: c[5]?.v || "",
        statusRaw: c[7]?.v || "",
        updatedText: updatedDate ? fmtDate(updatedDate) : "",
        reaction: createdDate && updatedDate ? Math.round((updatedDate-createdDate)/60000)+" min" : "",
        campaign: c[9]?.v || ""
      };
    });

    // load campaigns
    const campaigns = [...new Set(allRows.map(r=>r.campaign).filter(Boolean))];
    campaignFilter.innerHTML = `<option value="">‚Äî Kampania ‚Äî</option>` +
      campaigns.map(c=>`<option value="${c}">${c}</option>`).join("");

    loadingEl.style.display = "none";
    renderRows();
  });
}

searchInput.oninput = renderRows;
statusFilter.onchange = renderRows;
campaignFilter.onchange = renderRows;
dateFrom.onchange = renderRows;
dateTo.onchange = renderRows;
sortOrder.onchange = renderRows;

loadSheet();
</script>

</body>
</html>
