<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leady</title>
    <link rel="stylesheet" href="styles.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background: #f4f4f4;
        }

        #loader {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 0 4px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            font-size: 13px;
        }

        th {
            background: #eee;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            text-transform: capitalize;
            text-align: center;
            display: inline-block;
        }

        .status-nowy { background: #007bff; }
        .status-lead-odrzucony { background: #dc3545; }
        .status-nie-odbiera { background: #ffc107; color: black; }
        .status-wizyta-umowiona { background: #28a745; }
        .status-porzucony { background: #6c757d; }
    </style>
</head>
<body>

    <h2>Leady z kampanii Meta Ads</h2>

    <div id="loader">Ładowanie danych...</div>

    <div class="stats">
        <div>Nowe: <span id="stat-new">0</span></div>
        <div>Odrzucone: <span id="stat-odrzucone">0</span></div>
        <div>Nie odbiera: <span id="stat-nieodbiera">0</span></div>
        <div>Umówione: <span id="stat-umowione">0</span></div>
        <div>Porzucone: <span id="stat-porzucone">0</span></div>
    </div>

    <div class="controls">
        <select id="statusFilter">
            <option value="">— Status —</option>
            <option value="Nowy">Nowy</option>
            <option value="Lead odrzucony">Lead odrzucony</option>
            <option value="Nie odbiera">Nie odbiera</option>
            <option value="Wizyta umówiona">Wizyta umówiona</option>
            <option value="Porzucony">Porzucony</option>
        </select>

        <input type="date" id="dateFrom">
        <input type="date" id="dateTo">

        <select id="sortOrder">
            <option value="desc">Najnowsze</option>
            <option value="asc">Najstarsze</option>
        </select>

        <select id="campaignFilter">
            <option value="">— Kampania —</option>
        </select>
    </div>

    <table id="leadTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Data</th>
                <th>Imię</th>
                <th>Telefon</th>
                <th>Email</th>
                <th>Cel</th>
                <th>Status</th>
                <th>Data aktualizacji</th>
                <th>Reakcja</th>
                <th>Kampania</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>


<script>
let allRows = [];

async function loadData() {
    try {
        const res = await fetch(
            "https://docs.google.com/spreadsheets/d/1pqfVCI-chR0e6TZNgTh4T5bFWcNSrH1h5XlmPRCfjBk/export?format=json"
        );

        const raw = await res.text();
        const jsonStr = raw.replace(/^\)\]\}'/, '');
        const data = JSON.parse(jsonStr);
        const rows = data.table.rows;

        allRows = rows.map(r => {
            const id = r.c[0]?.v ?? "";
            const createdRaw = r.c[1]?.f ?? "";
            const createdDate = createdRaw ? new Date(createdRaw) : null;
            const name = r.c[2]?.v ?? "";
            const phone = r.c[3]?.v ?? "";
            const email = r.c[4]?.v ?? "";
            const cel = r.c[5]?.v ?? "";
            const statusRaw = r.c[6]?.v ?? "";
            const updatedRaw = r.c[7]?.f ?? "";
            const updatedDate = updatedRaw ? new Date(updatedRaw) : null;
            const reaction = r.c[8]?.v ?? "";
            const campaign = r.c[9]?.v ?? "";

            return {
                id,
                createdDate,
                createdText: createdRaw,
                name,
                phone,
                email,
                cel,
                statusRaw,
                updatedDate,
                updatedText: updatedRaw,
                reaction,
                campaign
            };
        });

        fillCampaignList();
        renderRows(allRows);
        document.getElementById("loader").style.display = "none";

    } catch (e) {
        doc.getElementById("loader").innerHTML = "Błąd ładowania danych.";
        console.error(e);
    }
}

function fillCampaignList() {
    const select = document.getElementById("campaignFilter");
    const unique = [...new Set(allRows.map(r => r.campaign).filter(v => v))];

    unique.forEach(c => {
        let o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        select.appendChild(o);
    });
}

function renderRows(rows) {
    const body = document.getElementById("tableBody");
    body.innerHTML = "";

    const filterStatus = document.getElementById("statusFilter").value.toLowerCase();
    const dateFrom = new Date(document.getElementById("dateFrom").value);
    const dateTo   = new Date(document.getElementById("dateTo").value);
    const sortOrder = document.getElementById("sortOrder").value;
    const camp = document.getElementById("campaignFilter").value.toLowerCase();

    let filtered = rows.filter(r => {

        if (filterStatus && r.statusRaw.toLowerCase() !== filterStatus) return false;

        if (camp && r.campaign.toLowerCase() !== camp) return false;

        if (dateFrom.toString() !== "Invalid Date") {
            if (!r.createdDate || r.createdDate < dateFrom) return false;
        }

        if (dateTo.toString() !== "Invalid Date") {
            if (!r.createdDate || r.createdDate > dateTo) return false;
        }

        return true;
    });

    filtered.sort((a, b) => {
        if (!a.createdDate || !b.createdDate) return 0;
        return sortOrder === "asc"
            ? a.createdDate - b.createdDate
            : b.createdDate - a.createdDate;
    });

    filtered.forEach(r => {
        const tr = document.createElement("tr");

        const statusClass = "status-" + r.statusRaw.toLowerCase().replace(/\s+/g, "-");

        tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.createdText}</td>
            <td>${r.name}</td>
            <td>${r.phone}</td>
            <td>${r.email}</td>
            <td>${r.cel}</td>
            <td><span class="status-badge ${statusClass}">${r.statusRaw}</span></td>
            <td>${r.updatedText}</td>
            <td>${r.reaction}</td>
            <td>${r.campaign}</td>
        `;

        body.appendChild(tr);
    });

    updateStats(filtered);
}

function updateStats(rows) {
    document.getElementById("stat-new").textContent =
        rows.filter(r => r.statusRaw === "Nowy").length;

    document.getElementById("stat-odrzucone").textContent =
        rows.filter(r => r.statusRaw === "Lead odrzucony").length;

    document.getElementById("stat-nieodbiera").textContent =
        rows.filter(r => r.statusRaw === "Nie odbiera").length;

    document.getElementById("stat-umowione").textContent =
        rows.filter(r => r.statusRaw === "Wizyta umówiona").length;

    document.getElementById("stat-porzucone").textContent =
        rows.filter(r => r.statusRaw === "Porzucony").length;
}

document.getElementById("statusFilter").addEventListener("change", () => renderRows(allRows));
document.getElementById("dateFrom").addEventListener("change", () => renderRows(allRows));
document.getElementById("dateTo").addEventListener("change", () => renderRows(allRows));
document.getElementById("sortOrder").addEventListener("change", () => renderRows(allRows));
document.getElementById("campaignFilter").addEventListener("change", () => renderRows(allRows));

loadData();
</script>

</body>
</html>
