<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard lead√≥w ‚Äî Firma1</title>
<style>
  :root{
    --bg:#f4f7fa; --card:#fff; --muted:#6c757d; --accent-start:#00bcd4; --accent-end:#9c27b0;
  }
  body{font-family:"Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);margin:0;padding:12px;box-sizing:border-box;color:#222}
  .wrap{max-width:1100px;margin:12px auto}
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06);overflow:hidden}
  header{background:linear-gradient(135deg,var(--accent-start),var(--accent-end));color:#fff;padding:16px;text-align:center}
  header h1{margin:0;font-size:18px}
  .controls{display:flex;gap:10px;padding:12px;flex-wrap:wrap;align-items:center}
  .controls .search{flex:1;min-width:200px}
  input[type="text"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf2;background:#fff;box-sizing:border-box}
  .stats{display:flex;gap:12px;padding:12px;flex-wrap:wrap}
  .stat{flex:1 1 30%;background:#f0faff;border-left:4px solid var(--accent-start);padding:12px;border-radius:8px;font-weight:700;text-align:center}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #eef2f5;text-align:left;vertical-align:middle}
  th{background:#fafcff;font-weight:700}
  .status{padding:6px 8px;border-radius:8px;color:#fff;font-weight:700;font-size:13px;display:inline-block}
  /* status colors */
  .s-nowy{background:#9c27b0}          /* nowy / oczekuje */
  .s-oczekuje{background:#9c27b0}
  .s-w_kontakcie{background:#2196f3}  /* w kontakcie */
  .s-odebral{background:#4caf50}      /* odebra≈Ç */
  .s-wizyta_umowiona{background:#009688} /* wizyta um√≥wiona */
  .s-nie_odebral{background:#ff9800}  /* nie odebra≈Ç */
  .s-odrzucony{background:#f44336}    /* odrzucony */
  .s-porzucony{background:#607d8b}    /* porzucony */
  .s-default{background:#6c757d}      /* fallback */
  .small{font-size:13px;color:var(--muted)}
  .table-wrap{overflow:auto}
  .controls .hint{font-size:13px;color:var(--muted)}
  @media (max-width:800px){
    .stat{flex:1 1 48%}
    th,td{padding:8px;font-size:13px}
  }
  /* przyciski akcji (opcjonalne) */
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;color:#fff;text-decoration:none;text-align:center;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #e6edf2;color:#333}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>üìä Dashboard lead√≥w ‚Äî Firma1</h1>
      </header>

      <div style="padding:12px;">
        <div class="controls">
          <div style="flex:1;min-width:200px">
            <input id="search" class="search" type="text" placeholder="Szukaj: imiƒô, telefon, email..." />
          </div>

          <div style="width:220px">
            <select id="statusFilter">
              <option value="">‚Äî Filtruj po statusie ‚Äî</option>
              <option value="nowy">Nowy / Oczekuje</option>
              <option value="w_kontakcie">W kontakcie</option>
              <option value="odebral">Odebra≈Ç</option>
              <option value="wizyta_umowiona">Wizyta um√≥wiona</option>
              <option value="nie_odebral">Nie odebra≈Ç</option>
              <option value="odrzucony">Odrzucony</option>
              <option value="porzucony">Porzucony</option>
            </select>
          </div>

          <div style="width:140px">
            <select id="refreshInterval">
              <option value="60">Od≈õwie≈º co 60s</option>
              <option value="0">Wy≈ÇƒÖcz auto</option>
            </select>
          </div>

          <div style="min-width:120px">
            <span class="hint small">Statusy kolorowane automatycznie</span>
          </div>
        </div>

        <div class="stats" id="stats" style="display:none">
          <div class="stat">Nowe: <span id="stat-nowe">0</span></div>
          <div class="stat">Obs≈Çu≈ºone / Um√≥wione: <span id="stat-done">0</span></div>
          <div class="stat">Nieodebrane / Porzucone: <span id="stat-bad">0</span></div>
        </div>

        <div class="table-wrap" style="padding:12px;">
          <div id="loading" class="small">≈Åadowanie danych z Google Sheets‚Ä¶</div>
          <table id="leadsTable" style="display:none">
            <thead>
              <tr>
                <th style="width:70px">ID</th>
                <th style="width:160px">Data zg≈Çoszenia</th>
                <th>Pacjent</th>
                <th style="width:120px">Telefon</th>
                <th style="width:200px">Email</th>
                <th>Cel wizyty</th>
                <th style="width:140px">Status</th>
                <th style="width:160px">Data aktualizacji</th>
                <th style="width:120px">Czas reakcji</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

<script>
/* ====== KONFIGURACJA ======
   Podmieniƒá SHEET_ID je≈õli inny
   Sheet name: Firma1
   Opcjonalnie: w przysz≈Ço≈õci wpisz tutaj webhook Zapier w celu zmian status√≥w z UI
===========================*/
const SHEET_ID = "1WubNwZuof8s8Udg93k0C9Qgo-VkPXiQT0_7-VeEg81k";
const SHEET_NAME = "Firma1";
const ZAPIER_WEBHOOK = ""; // je≈õli chcesz wysy≈Çaƒá zmiany status√≥w do Zapier, wpisz URL tutaj
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

/* ====== HELPERS ====== */
function parseGvizResponseText(text){
  // usu≈Ñ wrapper google.visualization.Query.setResponse(...)
  const jsonText = text.replace(/^[^\(]*\(/, '').replace(/\);?$/,'');
  return JSON.parse(jsonText);
}

function parseGvizDateCell(cell){
  if (!cell) return null;
  // 1) je≈õli jest cell.f i wyglƒÖda OK
  if (cell.f){
    const d = new Date(cell.f);
    if (!isNaN(d)) return d;
  }
  // 2) je≈õli v jest string 'Date(YYYY,MM,DD,HH,MM,SS)'
  const v = cell.v;
  if (typeof v === 'string'){
    const m = v.match(/Date\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
    if (m){
      const Y = +m[1], M = +m[2], D = +m[3], h = +m[4], min = +m[5], s = +m[6];
      return new Date(Y, M, D, h, min, s);
    }
    // spr√≥buj parsowaƒá ISO
    const iso = new Date(v);
    if (!isNaN(iso)) return iso;
  }
  if (typeof v === 'number'){
    return new Date(v);
  }
  return null;
}

function fmtDate(d){
  if (!d) return '';
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function diffHuman(from, to){
  if (!from || !to) return '';
  let s = Math.floor((to - from) / 1000);
  if (s < 0) s = 0;
  const days = Math.floor(s / 86400); s %= 86400;
  const hours = Math.floor(s / 3600); s %= 3600;
  const mins = Math.floor(s / 60);
  if (days>0) return `${days}d ${hours}h ${mins}m`;
  if (hours>0) return `${hours}h ${mins}m`;
  if (mins>0) return `${mins}m`;
  return '<1m';
}

function normalizeKey(s){
  if (!s) return '';
  return s.toString().toLowerCase().trim();
}

function statusClassFor(raw){
  const s = normalizeKey(raw);
  if (!s) return 's-nowy';
  if (s.includes('porzu')) return 's-porzucony';
  if (s.includes('odrzu')) return 's-odrzucony';
  if (s.includes('nie') && (s.includes('odebr')|| s.includes('odb'))) return 's-nie_odebral';
  if (s.includes('nie_odebra') || s.includes('nie odb')) return 's-nie_odebral';
  if (s.includes('wizyta') || s.includes('umow') || s.includes('um√≥wi')) return 's-wizyta_umowiona';
  if (s.includes('odebr') || s.includes('odebra')) return 's-odebral';
  if (s.includes('kontakt') || s.includes('w kontakt') || s.includes('kontaktuje')) return 's-w_kontakcie';
  if (s.includes('now') || s.includes('oczek')) return 's-nowy';
  return 's-default';
}

/* ====== RENDER ====== */
const tableBody = document.querySelector('#leadsTable tbody');
const loadingEl = document.getElementById('loading');
const statsEl = document.getElementById('stats');
const statNowe = document.getElementById('stat-nowe');
const statDone = document.getElementById('stat-done');
const statBad = document.getElementById('stat-bad');
const searchInput = document.getElementById('search');
const statusFilter = document.getElementById('statusFilter');
const refreshSelect = document.getElementById('refreshInterval');

let allRows = [];
let refreshTimer = null;

function renderRows(rows){
  tableBody.innerHTML = '';
  let cntNowe=0, cntDone=0, cntBad=0;
  const filter = normalizeKey(statusFilter.value || '');
  const q = normalizeKey(searchInput.value || '');

  rows.forEach(r=>{
    const id = r.id || '';
    const created = r.createdDate;
    const createdText = r.createdText || '';
    const name = r.name || '';
    const phone = r.phone || '';
    const email = r.email || '';
    const cel = r.cel || '';
    const statusRaw = r.statusRaw || '';
    const updatedText = r.updatedText || '';
    const reaction = r.reaction || '';

    // filtrowanie
    if (filter){
      const cls = statusClassFor(statusRaw);
      if (!cls.includes(filter)) return;
    }
    if (q){
      const hay = (name + ' ' + phone + ' ' + email + ' ' + cel).toLowerCase();
      if (!hay.includes(q)) return;
    }

    // statystyki (aggregacja)
    const sk = normalizeKey(statusRaw);
    if (sk.includes('now') || sk.includes('oczek')) cntNowe++;
    if (sk.includes('odebr') || sk.includes('wizyta') || sk.includes('umow') || sk.includes('um√≥wi') ) cntDone++;
    if (sk.includes('nie') && (sk.includes('odb')||sk.includes('odebr'))) cntBad++;
    if (sk.includes('porzu')) cntBad++;

    const spanClass = statusClassFor(statusRaw);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(id)}</td>
      <td>${escapeHtml(createdText)}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(email)}</td>
      <td>${escapeHtml(cel)}</td>
      <td><span class="status ${spanClass}">${escapeHtml(statusRaw || 'oczekuje')}</span></td>
      <td>${escapeHtml(updatedText)}</td>
      <td>${escapeHtml(reaction)}</td>
    `;
    tableBody.appendChild(tr);
  });

  // ustaw statystyki
  statNowe.innerText = cntNowe;
  statDone.innerText = cntDone;
  statBad.innerText = cntBad;

  loadingEl.style.display = 'none';
  document.getElementById('leadsTable').style.display = tableBody.children.length ? 'table' : 'none';
  statsEl.style.display = 'flex';
}

/* ====== LOAD SHEET ====== */
function loadSheet(){
  loadingEl.style.display = 'block';
  fetch(GVIZ_URL).then(r=>r.text()).then(t=>{
    const json = parseGvizResponseText(t);
    const rows = json.table.rows || [];
    allRows = rows.map(r=>{
      // kolumny A..I => 0..8
      const idCell = r.c[0] || {};
      const dateCell = r.c[1] || {};
      const nameCell = r.c[2] || {};
      const phoneCell = r.c[3] || {};
      const emailCell = r.c[4] || {};
      const celCell = r.c[5] || {};
      const infoCell = r.c[6] || {};
      const statusCell = r.c[7] || {};
      const updatedCell = r.c[8] || {};

      const id = idCell.v ?? '';
      const createdDate = parseGvizDateCell(dateCell);
      const createdText = createdDate ? fmtDate(createdDate) : (dateCell.f || dateCell.v || '');
      const name = nameCell.v ?? '';
      const phone = phoneCell.v ?? '';
      const email = emailCell.v ?? '';
      const cel = celCell.v ?? '';
      const statusRaw = statusCell.v ?? (statusCell.f ?? '') ;
      const updatedDate = parseGvizDateCell(updatedCell);
      const updatedText = updatedDate ? fmtDate(updatedDate) : (updatedCell.f || updatedCell.v || '');
      const reaction = (createdDate && updatedDate) ? diffHuman(createdDate, updatedDate) : '';

      return {
        id, createdDate, createdText, name, phone, email, cel, statusRaw, updatedDate, updatedText, reaction
      };
    });
    renderRows(allRows);
  }).catch(e=>{
    console.error(e);
    loadingEl.innerText = 'B≈ÇƒÖd ≈Çadowania arkusza. Sprawd≈∫ uprawnienia i nazwƒô zak≈Çadki (Firma1).';
  });
}

/* ====== EVENTS ====== */
searchInput.addEventListener('input', ()=> renderRows(allRows));
statusFilter.addEventListener('change', ()=> renderRows(allRows));
refreshSelect.addEventListener('change', ()=>{
  if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
  const val = Number(refreshSelect.value);
  if (val>0) refreshTimer = setInterval(loadSheet, val*1000);
});

/* auto-refresh domy≈õlnie co 60s */
refreshTimer = setInterval(loadSheet, 60000);

/* initial load */
loadSheet();

/* ===== minor helpers ===== */
function fmtDate(d){ if(!d) return ''; const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function diffHuman(from,to){ if(!from||!to) return ''; let s=Math.floor((to-from)/1000); if(s<0) s=0; const days=Math.floor(s/86400); s%=86400; const hours=Math.floor(s/3600); s%=3600; const mins=Math.floor(s/60); if(days>0) return `${days}d ${hours}h ${mins}m`; if(hours>0) return `${hours}h ${mins}m`; if(mins>0) return `${mins}m`; return '<1m'; }
function parseGvizResponseText(t){ const jsonText = t.replace(/^[^\(]*\(/,'').replace(/\);?$/,''); return JSON.parse(jsonText); }
function parseGvizDateCell(cell){
  if(!cell) return null;
  if(cell.f){
    const d=new Date(cell.f); if(!isNaN(d)) return d;
  }
  const v = cell.v;
  if(typeof v==='string'){
    const m=v.match(/Date\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
    if(m){ return new Date(+m[1],+m[2],+m[3],+m[4],+m[5],+m[6]); }
    const iso=new Date(v); if(!isNaN(iso)) return iso;
  }
  if(typeof v==='number') return new Date(v);
  return null;
}
function statusClassFor(raw){
  const s = normalizeKey(raw);
  if(!s) return 's-nowy';
  if(s.includes('porzu')) return 's-porzucony';
  if(s.includes('odrz') || s.includes('odrzu')) return 's-odrzucony';
  if((s.includes('nie') && (s.includes('odebr')||s.includes('odb'))) || s.includes('nie_odebra')) return 's-nie_odebral';
  if(s.includes('wizyta') || s.includes('umow') || s.includes('um√≥wi')) return 's-wizyta_umowiona';
  if(s.includes('odebr') || s.includes('odebra')) return 's-odebral';
  if(s.includes('kontakt') || s.includes('w_kontakt') || s.includes('kontaktuje')) return 's-w_kontakcie';
  if(s.includes('now') || s.includes('oczek')) return 's-nowy';
  return 's-default';
}
function normalizeKey(s){ if(!s) return ''; return s.toString().toLowerCase().trim(); }

</script>
</body>
</html>
