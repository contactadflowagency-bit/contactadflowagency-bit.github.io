<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Status leada</title>

<style>
  body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background:#f7f8fa; margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center; }
  .wrapper { max-width:600px; width:90%; background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); overflow:hidden; }
  .header { background: linear-gradient(135deg, #00bcd4, #9c27b0); color:#fff; padding:24px; text-align:center; }
  .header img { width:70px; border-radius:16px; display:block; margin:0 auto 10px; }
  .header h2 { margin:0; font-size:22px; }
  .content { padding:26px 30px; }
  .box { background:#f4fbfd; border-left:4px solid #00bcd4; padding:16px 20px; border-radius:6px; margin-bottom:20px; }
  .box.data { background:#f0faff; }
  p { margin:6px 0; font-size:15px; }
  .buttons { text-align:center; margin:30px 0; }
  .buttons a { display:inline-block; margin:6px; padding:12px 20px; border-radius:6px; color:white; text-decoration:none; font-weight:bold; cursor: pointer; transition: opacity 0.2s; }
  .buttons a:hover { opacity: 0.8; }
  .obs { background:#4caf50; } .nie { background:#ff9800; } .odrz { background:#f44336; }
  .footer { background:#f7f8fa; text-align:center; padding:14px; font-size:12px; color:#999; }
  .status-badge { display:inline-block; padding:6px 12px; border-radius:999px; font-weight:700; font-size:14px; color:#fff; }
  .s-nowy { background:#9c27b0; } .s-porzucony { background: #9e9e9e; } .s-nie_odbiera { background:#ff9800; } .s-obsluzony { background:#4caf50; } .s-odrzucony { background:#f44336; }
  .status-row { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
  .muted { font-size:13px; color:#777; }
  .disabled { opacity:.4; pointer-events: none; cursor: default; }
  
  /* DASHBOARD UI */
  body.dashboard-mode .wrapper { max-width: 1400px; width: 95%; margin: 20px auto; }
  .dashboard-toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
  .dashboard-toolbar input, .dashboard-toolbar select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; outline: none; }
  .btn-tool { padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; }
  .btn-tool:hover { background: #f9f9f9; border-color: #bbb; }
  .table-scroll { width: 100%; overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
  .dashboard-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1000px; }
  .dashboard-table thead th { background: #f4f7fb; padding: 12px 10px; text-align: left; border-bottom: 2px solid #e3e7ee; cursor: pointer; }
  .dashboard-table tbody td { padding: 12px 10px; border-bottom: 1px solid #eee; }

  .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 9999; }
  .loader.hidden { display: none; }
  .loader-box { background: #fff; padding: 30px 40px; border-radius: 12px; text-align: center; }
  .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #333; border-radius: 50%; animation: spin 0.9s linear infinite; margin: 0 auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<div class="wrapper" id="app">
  <div class="content">‚è≥ ≈ÅƒÖczenie z serwerem‚Ä¶</div>
</div>

<div id="loader" class="loader hidden">
  <div class="loader-box">
    <div class="spinner"></div>
    <div class="loader-text">≈Åadowanie...</div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzBLTLdMX1DXfLdDjiIit97OWNNaIjdiXqj9_bVtWSdytJAy4x9SvRTZdSP8t3Ysd-7/exec";
const params = new URLSearchParams(window.location.search);
const row = params.get("row");
const token = params.get("token");
const action = params.get("action");
const app = document.getElementById("app");

// === STAN APLIKACJI ===
let offset = 0;
const LIMIT = 30;
let allRows = []; 
let totalLeads = 0;
let sortOrder = "desc";
let currentSortKey = 'created';
let fullyLoaded = false;
let loadingAll = false;
let sortDir = 1;
let pendingStatus = null;

// === INICJALIZACJA ===
window.onload = () => {
    if (action === "list") {
        renderListLayout();
        loadList(true);
    } else if (row && token) {
        loadSingle();
    } else {
        showError("Nieprawid≈Çowy link.");
    }
};

// === WIDOK POJEDYNCZEGO LEADA ===
function loadSingle() {
    document.body.classList.remove("dashboard-mode");
    fetch(`${API_URL}?row=${row}&token=${token}`)
        .then(r => r.json())
        .then(d => d.success ? renderSingle(d.lead) : showError("Brak dostƒôpu do leada"))
        .catch(err => showError("B≈ÇƒÖd po≈ÇƒÖczenia."));
}

function renderSingle(lead) {
    const status = lead["Obecny status"] || "nowy";
    const lastUpdate = lead["Data ostatniej aktualizacji"];
    const editable = canEdit(lastUpdate, status);

    app.innerHTML = `
        <div class="header">
            <img src="https://scontent-waw2-2.xx.fbcdn.net/v/t39.30808-6/540904522_122143092902741193_6153063326804191448_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=EXFBb3EdkUsQ7kNvwGb2Smp&_nc_oc=Adngi_kLnbg9pQiId6dkbJxk2TSxZhFWngOi9hCe_Ny49faPOIFTWxxq8fgzzJADO7I&_nc_zt=23&_nc_ht=scontent-waw2-2.xx&_nc_gid=w7niD_O83PtXyVLS5FjwZg&oh=00_AfkKwh5kzI8KNfgAR8NLvYEUObCW-JZmOSS3fx9QybdVYg&oe=6949BD8D" alt="AdFlow">
            <h2>Status kontaktu z pacjentem</h2>
        </div>
        <div class="content">
            <div class="box">
                <div class="status-row">
                    <div>
                        <p>üÜî <strong>Lead ID:</strong> ${lead["Id."]}</p>
                        <p>üìÖ <strong>Zg≈Çoszenie:</strong> ${formatDate(lead["Data"])}</p>
                    </div>
                    <div>
                        <span class="status-badge ${statusClass(status)}">${status.toUpperCase()}</span>
                        <div class="muted">Aktualizacja:<br>${formatDate(lastUpdate)}</div>
                    </div>
                </div>
            </div>
            <div class="box data">
                <p><strong>üßæ Pacjent:</strong> ${lead["Imiƒô Nazwisko"]}</p>
                <p><strong>üìû Telefon:</strong> ${formatPhone(lead["Nr tel"])}</p>
                <p><strong>ü¶∑ Cel:</strong> ${lead["Pytanie 1 (cel wizyty)"]}</p>
            </div>
            <div class="buttons ${editable ? "" : "disabled"}">
                <a class="obs" onclick="${editable ? `handleStatusClick('obsluzony','${status}')` : ''}">‚úî Obs≈Çu≈ºony</a>
                <a class="nie" onclick="${editable ? `handleStatusClick('nie_odbiera','${status}')` : ''}">üìû Nie odbiera</a>
                <a class="odrz" onclick="${editable ? `handleStatusClick('odrzucony','${status}')` : ''}">‚ùå Odrzucony</a>
            </div>
            ${!editable ? `<p class="muted" style="text-align:center">‚õî Status zablokowany (minƒô≈Ço 15 min)</p>` : ''}
        </div>
        <div id="confirmModal" class="modal hidden">
            <div class="modal-box">
                <h3>Zmieniƒá status?</h3>
                <p>Czy na pewno chcesz zmieniƒá status tego leada?</p>
                <div class="modal-actions">
                    <button class="cancel" onclick="closeModal()">Anuluj</button>
                    <button class="confirm" id="confirmBtn">Tak, zmie≈Ñ</button>
                </div>
            </div>
        </div>
    `;
}

// === WIDOK DASHBOARDU ===
function renderListLayout() {
    document.body.classList.add("dashboard-mode");
    app.innerHTML = `
        <div class="header"><h2>üìä Dashboard lead√≥w</h2></div>
        <div class="content">
            <div class="dashboard-toolbar">
                <input type="text" id="searchInput" placeholder="üîç Szukaj..." oninput="recomputeView()" style="flex: 1;">
                <select id="statusFilter" onchange="recomputeView()">
                    <option value="">‚Äî Wszystkie statusy ‚Äî</option>
                    <option value="nowy">Nowy</option>
                    <option value="obsluzony">Obs≈Çu≈ºony</option>
                    <option value="nie_odbiera">Nie odbiera</option>
                    <option value="odrzucony">Odrzucony</option>
                </select>
                <select id="campaignFilter" onchange="recomputeView()"><option value="">‚Äî Kampanie ‚Äî</option></select>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="date" id="dateFrom" onchange="loadList(true)">
                    <span>-</span>
                    <input type="date" id="dateTo" onchange="loadList(true)">
                </div>
                <button onclick="toggleDateSort()" id="sortBtn" style="padding:8px; cursor:pointer">üìÖ Najnowsze</button>
                <button onclick="clearAllFilters()" style="padding:8px; cursor:pointer">üßπ</button>
            </div>
            <div class="table-scroll">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('id')">ID</th>
                            <th onclick="sortTable('created')">Data</th>
                            <th onclick="sortTable('name')">Pacjent</th>
                            <th onclick="sortTable('status')">Status</th>
                            <th onclick="sortTable('updated')">Ost. akt.</th>
                            <th>Czas oczek.</th>
                            <th onclick="sortTable('campaign')">Kampania</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div style="text-align:center; margin:20px">
                    <button id="loadMoreBtn" onclick="loadList(false)" style="padding:12px 20px; border-radius:8px; cursor:pointer; display:none;">‚ûï Za≈Çaduj wiƒôcej</button>
                </div>
            </div>
        </div>
    `;
}

function loadList(reset = true) {
    if (reset) {
        offset = 0;
        allRows = [];
        fullyLoaded = false;
    }

    const dateFrom = document.getElementById("dateFrom")?.value || "";
    const dateTo = document.getElementById("dateTo")?.value || "";
    
    showLoader(reset ? "Pobieranie danych..." : "Doczytywanie...");

    const url = `${API_URL}?action=list&token=${token}&limit=${LIMIT}&offset=${offset}&sort=${sortOrder}&dateFrom=${dateFrom}&dateTo=${dateTo}`;

    fetch(url)
        .then(r => r.json())
        .then(d => {
            hideLoader();
            if (!d.success) return showError("B≈ÇƒÖd autoryzacji.");

            totalLeads = d.total;
            allRows = reset ? d.rows : allRows.concat(d.rows);
            offset += d.rows.length;

            if (allRows.length >= totalLeads) fullyLoaded = true;

            populateCampaigns(allRows);
            recomputeView();
        })
        .catch(err => { hideLoader(); showError("B≈ÇƒÖd po≈ÇƒÖczenia."); });
}

function recomputeView() {
    let filtered = applyFilters(allRows);

    // Sortowanie lokalne
    filtered.sort((a, b) => {
        let valA = a[currentSortKey];
        let valB = b[currentSortKey];
        if (currentSortKey === 'created' || currentSortKey === 'updated') {
            return sortOrder === "asc" ? new Date(valA) - new Date(valB) : new Date(valB) - new Date(valA);
        }
        valA = (valA || "").toString().toLowerCase();
        valB = (valB || "").toString().toLowerCase();
        return valA < valB ? -1 * sortDir : (valA > valB ? 1 * sortDir : 0);
    });

    renderTableRows(filtered);

    // Przycisk "Za≈Çaduj wiƒôcej" pokazuje siƒô tylko je≈õli serwer ma wiƒôcej rekord√≥w ni≈º my w pamiƒôci
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    if (loadMoreBtn) {
        loadMoreBtn.style.display = (allRows.length < totalLeads) ? "inline-block" : "none";
    }
}

function renderTableRows(rows) {
    const tbody = document.getElementById("tableBody");
    if (!tbody) return;
    tbody.innerHTML = rows.map(r => `
        <tr>
            <td>${r.id}</td>
            <td>${formatDate(r.created)}</td>
            <td><strong>${r.name || "-"}</strong><br><small class="muted">${formatPhone(r.phone)}</small></td>
            <td><span class="status-badge ${statusClass(r.status)}">${(r.status || "nowy").toUpperCase()}</span></td>
            <td>${formatDate(r.updated)}</td>
            <td>${r.wait_time || "-"}</td>
            <td>${r.campaign || "-"}</td>
        </tr>
    `).join("");
}

function toggleDateSort() {
    sortOrder = (sortOrder === "desc") ? "asc" : "desc";
    currentSortKey = 'created';
    const btn = document.getElementById("sortBtn");
    if (btn) btn.innerText = sortOrder === "desc" ? "üìÖ Najnowsze" : "üìÖ Najstarsze";
    
    // CACHE LOGIC: Je≈õli mamy ju≈º wszystkie dane, tylko sortujemy. Je≈õli nie - pobieramy od nowa.
    if (fullyLoaded) {
        recomputeView();
    } else {
        loadList(true);
    }
}

// === POMOCNICZE / LOGIKA STATUS√ìW ===
function canEdit(lastUpdate, status) {
    const s = (status || "").toLowerCase();
    if (s === "" || s === "nowy" || s === "nie_odbiera") return true;
    if (!lastUpdate) return true;
    return (Date.now() - new Date(lastUpdate)) / 60000 <= 15;
}

function handleStatusClick(newStatus, currentStatus) {
    const s = (currentStatus || "").toLowerCase();
    if (s === "" || s === "nowy") { updateStatus(newStatus); return; }
    pendingStatus = newStatus;
    document.getElementById("confirmModal").classList.remove("hidden");
    document.getElementById("confirmBtn").onclick = () => { updateStatus(pendingStatus); closeModal(); };
}

async function updateStatus(s) {
    showLoader("Zapisywanie...");
    try {
        const res = await fetch(`${API_URL}?row=${row}&token=${token}&status=${s}`, { method: "POST" });
        const data = await res.json();
        if (data.success) {
            app.innerHTML = `<div class="content"><h3>‚úÖ Zapisano</h3><button onclick="location.reload()">Powr√≥t</button></div>`;
        } else showError("B≈ÇƒÖd: " + data.error);
    } catch (e) { showError("B≈ÇƒÖd sieci."); }
    finally { hideLoader(); }
}

function applyFilters(rows) {
    const q = document.getElementById("searchInput")?.value.toLowerCase() || "";
    const s = document.getElementById("statusFilter")?.value || "";
    const cf = document.getElementById("campaignFilter")?.value || "";
    return rows.filter(r => {
        if (q && !Object.values(r).join(" ").toLowerCase().includes(q)) return false;
        if (s && (r.status || "nowy") !== s) return false;
        if (cf && r.campaign !== cf) return false;
        return true;
    });
}

function sortTable(key) {
    if (currentSortKey === key) { sortDir *= -1; sortOrder = (sortDir === 1 ? "asc" : "desc"); } 
    else { currentSortKey = key; sortDir = 1; sortOrder = "asc"; }
    recomputeView();
}

function populateCampaigns(rows) {
    const select = document.getElementById("campaignFilter");
    if(!select) return;
    const campaigns = [...new Set(rows.map(r => r.campaign).filter(Boolean))].sort();
    select.innerHTML = '<option value="">‚Äî Kampanie ‚Äî</option>' + campaigns.map(c => `<option value="${c}">${c}</option>`).join("");
}

function clearAllFilters() {
    document.getElementById("searchInput").value = "";
    document.getElementById("statusFilter").value = "";
    document.getElementById("dateFrom").value = "";
    document.getElementById("dateTo").value = "";
    loadList(true);
}

function formatDate(iso) { if (!iso) return "-"; return new Date(iso).toLocaleString("pl-PL", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" }); }
function showLoader(t) { const l = document.getElementById("loader"); if (l) { l.querySelector(".loader-text").textContent = t; l.classList.remove("hidden"); } }
function hideLoader() { const l = document.getElementById("loader"); if (l) l.classList.add("hidden"); }
function showError(m) { app.innerHTML = `<div class="content"><h3>‚õî B≈ÇƒÖd</h3><p>${m}</p><button onclick="location.reload()">üîÑ Pon√≥w</button></div>`; }
function statusClass(s) { const k = (s || "").toLowerCase(); const m = { "nowy": "s-nowy", "nie_odbiera": "s-nie_odbiera", "obsluzony": "s-obsluzony", "odrzucony": "s-odrzucony" }; return m[k] || "s-nowy"; }
function formatPhone(p) { if (!p) return "-"; let d = p.toString().replace(/\D/g, ""); if (d.startsWith("48") && d.length === 11) d = d.slice(2); return d.length === 9 ? `+48 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}` : p; }
function closeModal() { document.getElementById("confirmModal").classList.add("hidden"); pendingStatus = null; }
</script>
</body>
</html>
