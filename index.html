<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdFlow - System Obs≈Çugi Lead√≥w</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background:#f7f8fa; margin:0; min-height:100vh; display:flex; justify-content:center; align-items:center; }
        .wrapper { max-width:600px; width:95%; background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); overflow:hidden; }
        .header { background: linear-gradient(135deg, #00bcd4, #9c27b0); color:#fff; padding:24px; text-align:center; position: relative; }
        .header img { width:70px; border-radius:16px; display:block; margin:0 auto 10px; object-fit: cover; height: 70px; }
        .header h2 { margin:0; font-size:22px; }
        .content { padding:26px 30px; }
        .box { background:#f4fbfd; border-left:4px solid #00bcd4; padding:16px 20px; border-radius:6px; margin-bottom:20px; text-align: left; }
        .box.data { background:#f0faff; }
        p { margin:6px 0; font-size:15px; }
        .buttons { text-align:center; margin:30px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .buttons a, .btn-modal { display:inline-block; padding:12px 20px; border-radius:6px; color:white; text-decoration:none; font-weight:bold; cursor: pointer; transition: opacity 0.2s; border: none; font-size: 14px; }
        .buttons a:hover { opacity: 0.8; }
        .obs { background:#2E7D32; } 
        .nie { background:#FF9800; } 
        .odrz { background:#D32F2F; }
        .close-btn { background:#555; }
        .status-badge { display:inline-block; padding:6px 12px; border-radius:999px; font-weight:700; font-size:12px; color:#fff; text-transform: uppercase; }
        .s-nowy { background: #2196F3; }
        .s-obsluzony { background: #2E7D32; }
        .s-nie_odbiera { background: #FF9800; }
        .s-odrzucony { background: #D32F2F; }
        .s-porzucony { background: #9E9E9E; }
        .status-row { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
        .muted { font-size:13px; color:#777; }
        .disabled { opacity:.4; pointer-events: none; cursor: default; }
        body.dashboard-mode { align-items: flex-start; }
        body.dashboard-mode .wrapper { max-width: 1400px; margin: 20px auto; }
        .dashboard-toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .dashboard-toolbar input, .dashboard-toolbar select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; outline: none; }
        .btn-tool { padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .btn-apply { background: #2563eb !important; color: white !important; border: none; }
        .multiselect { position: relative; display: inline-block; }
        .multiselect-btn { padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; min-width: 160px; text-align: left; display:flex; justify-content: space-between; align-items: center; }
        .multiselect-content { display: none; position: absolute; background-color: #fff; min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 100; border: 1px solid #eee; border-radius: 8px; max-height: 300px; overflow-y: auto; top: 110%; left: 0; }
        .multiselect-content.show { display: block; }
        .multiselect-content label { color: black; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer; border-bottom: 1px solid #f9f9f9; font-size: 13px; text-align: left;}
        .multiselect-content label:hover { background-color: #f1f1f1; }
        .multiselect-content input { margin-right: 10px; }
        .table-scroll { width: 100%; overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        .dashboard-table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 1000px; }
        .dashboard-table thead th { background: #f4f7fb; padding: 12px 10px; text-align: left; border-bottom: 2px solid #e3e7ee; }
        .dashboard-table tbody td { padding: 12px 10px; border-bottom: 1px solid #eee; }
        .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loader.hidden { display: none !important; }
        .loader-box { background: #fff; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .modal-preview-box { max-width: 600px; width: 95%; padding: 0; overflow: hidden; }
        .modal-close-x { position: absolute; top: 15px; right: 15px; color: white; font-size: 24px; cursor: pointer; z-index: 10; font-weight: bold;}
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #333; border-radius: 50%; animation: spin 0.9s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>

    <div class="wrapper" id="app">
        <div class="content" style="text-align:center;">‚è≥ ≈ÅƒÖczenie z serwerem...</div>
    </div>

    <div id="loader" class="loader hidden">
        <div class="loader-box">
            <div class="spinner"></div>
            <div class="loader-text">≈Åadowanie...</div>
        </div>
    </div>

    <div id="confirmModal" class="loader hidden">
        <div class="loader-box">
            <div style="font-weight:bold; font-size:18px; margin-bottom:10px;">Potwierd≈∫ zmianƒô</div>
            <div id="confirmMsg" style="margin-bottom:20px;"></div>
            <div class="buttons">
                <button class="btn-modal obs" id="confirmYes">Tak, zmie≈Ñ</button>
                <button class="btn-modal odrz" id="confirmNo">Anuluj</button>
            </div>
        </div>
    </div>

    <div id="previewModal" class="loader hidden" onclick="closePreview(event)">
        <div class="loader-box modal-preview-box" onclick="event.stopPropagation()">
            <div class="header">
                <div class="modal-close-x" onclick="closePreview()">√ó</div>
                <h2>Szczeg√≥≈Çy leada</h2>
            </div>
            <div class="content" id="previewContent"></div>
            <div style="background: #f9f9f9; padding: 15px; text-align: center;">
                <button class="btn-modal close-btn" onclick="closePreview()">Zamknij podglƒÖd</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzBLTLdMX1DXfLdDjiIit97OWNNaIjdiXqj9_bVtWSdytJAy4x9SvRTZdSP8t3Ysd-7/exec";
        const params = new URLSearchParams(window.location.search);
        const row = params.get("row");
        const token = params.get("token");
        const action = params.get("action");
        const app = document.getElementById("app");
        
        let allLeadsMap = new Map();
        let currentTotal = 0;
        let dashboardOffset = 0;
        let dashboardSort = "desc";
        let currentLeadStatus = "nowy";
        
        // --- ≈ÅADOWANIE POJEDYNCZEGO LEADA ---
        function loadSingle() {
            document.body.classList.remove("dashboard-mode");
            showLoader("Pobieranie danych leada...");
            fetch(`${API_URL}?row=${row}&token=${token}`)
                .then(r => r.json())
                .then(d => {
                    hideLoader();
                    if(d.success) {
                        currentLeadStatus = String(d.lead.statusKey || "nowy");
                        renderSingle(d.lead);
                    } else {
                        showError("B≈ÇƒÖd: " + (d.error || "Brak dostƒôpu"));
                    }
                })
                .catch(() => showError("B≈ÇƒÖd po≈ÇƒÖczenia z serwerem."));
        }
        
        function renderSingle(lead) {
            const editable = lead.canEdit; 
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(lead.name)}&background=0D8ABC&color=fff&size=128`;

            app.innerHTML = `
                <div class="header">
                    <img src="${avatarUrl}" alt="Avatar">
                    <h2>Status kontaktu</h2>
                </div>
                <div class="content">
                    <div class="box">
                        <div class="status-row">
                            <div>
                                <p>üÜî <strong>ID:</strong> ${lead.id || "-"}</p>
                                <p>üìÖ <strong>Zg≈Çoszenie:</strong> ${formatDate(lead.date)}</p>
                                <p>üì¢ <strong>Kampania:</strong> ${lead.campaign || "-"}</p>
                            </div>
                            <div style="text-align:right">
                                <span class="status-badge ${statusClass(lead.statusKey)}">${lead.status}</span>
                                <div class="muted" style="margin-top:5px">Aktualizacja:<br>${formatDate(lead.lastUpdate)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="box data">
                        <p><strong>üßæ Pacjent:</strong> ${lead.name || "-"}</p>
                        <p><strong>üìû Telefon:</strong> ${formatPhone(lead.phone)}</p>
                        <p><strong>üìß Email:</strong> ${lead.email || "-"}</p>
                        <p><strong>‚è±Ô∏è e:</strong> ${lead.wait_time_combined || "-"}</p>
                        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                        <p><strong>ü¶∑ Cel:</strong> ${lead.info1 || "-"}</p>
                        <p><strong>üìù Info:</strong> ${lead.info2 || "-"}</p>
                    </div>
                    <div class="buttons ${editable ? "" : "disabled"}">
                        <a class="obs" onclick="handleStatusClick('obsluzony')">‚úî Obs≈Çu≈ºony</a>
                        <a class="nie" onclick="handleStatusClick('nie_odbiera')">üìû Nie odbiera</a>
                        <a class="odrz" onclick="handleStatusClick('odrzucony')">‚ùå Odrzucony</a>
                    </div>
                    ${!editable ? `<p class="muted" style="text-align:center; color:#f44336; font-weight:bold; margin-top:20px;">‚õî Edycja zablokowana (porzucony lub > 20 min)</p>` : ''}
                </div>
            `;
        }
        
        // --- DASHBOARD ---
        function renderListLayout() {
            document.body.classList.add("dashboard-mode");
            app.innerHTML = `
                <div class="header">
                    <h2>üìä Dashboard lead√≥w</h2>
                </div>
                <div class="content">
                    <div class="dashboard-toolbar">
                        <div class="multiselect">
                            <div class="multiselect-btn" onclick="toggleDropdown('statusList')">
                                <span id="statusBtnText">üìå Statusy</span><span>‚ñº</span>
                            </div>
                            <div class="multiselect-content" id="statusList">
                                <label><input type="checkbox" value="nowy"> Nowy</label>
                                <label><input type="checkbox" value="obsluzony"> Obs≈Çu≈ºony</label>
                                <label><input type="checkbox" value="nie_odbiera"> Nie odbiera</label>
                                <label><input type="checkbox" value="odrzucony"> Odrzucony</label>
                                <label><input type="checkbox" value="porzucony"> Porzucony</label>
                            </div>
                        </div>
                    
                        <div class="multiselect">
                            <div class="multiselect-btn" onclick="toggleDropdown('campList')">
                                <span id="campBtnText">üì¢ Kampanie</span><span>‚ñº</span>
                            </div>
                            <div class="multiselect-content" id="campList">
                                <div style="padding:10px; color:#888;">≈Åadowanie...</div>
                            </div>
                        </div>
                    
                        <input type="date" id="dateFrom" title="Data od">
                        <input type="date" id="dateTo" title="Data do">
                        
                        <button onclick="toggleSort()" id="sortBtn" class="btn-tool">üìÖ Najnowsze</button>
                        
                        <button onclick="loadDashboard(true)" class="btn-tool btn-apply">üîç Zastosuj filtry</button>
                        
                        <button onclick="clearFilters()" class="btn-tool">üßπ Wyczy≈õƒá</button>
                    </div>

                    <div class="table-scroll">
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>ID</th><th>Data</th><th>Pacjent</th><th>Status</th><th>Ostatnia aktualizacja</th><th>Czas kontaktu (realny)</th><th>Kampania</th>
                                    <th style="text-align:center;">Akcja</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <div style="text-align:center; padding:20px;">
                            <button id="loadMoreBtn" onclick="loadDashboard(false)" class="btn-tool" style="display:none; margin: 0 auto;">Za≈Çaduj wiƒôcej</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Klikniƒôcie poza dropdowny zamyka je
            window.onclick = (e) => {
                if (!e.target.closest('.multiselect')) {
                    document.querySelectorAll('.multiselect-content').forEach(el => el.classList.remove('show'));
                }
            };
            fetchCampaigns();
        }

        function toggleDropdown(id) {
            const el = document.getElementById(id);
            const isShow = el.classList.contains("show");
            document.querySelectorAll('.multiselect-content').forEach(c => c.classList.remove('show'));
            if(!isShow) el.classList.add("show");
        }

        function fetchCampaigns() {
            fetch(`${API_URL}?action=campaigns&token=${token}`)
            .then(r => r.json())
            .then(d => {
                const container = document.getElementById("campList");
                if(d.success) {
                    // Zmieniono: brak atrybutu onchange w inputach
                    container.innerHTML = d.campaigns.map(c => `<label><input type="checkbox" value="${c}"> ${c}</label>`).join("");
                }
            });
        }

        function loadDashboard(reset = true) {
    if (reset) {
        dashboardOffset = 0;
        allLeadsMap.clear();
        document.getElementById("tableBody").innerHTML = "";
    }
    showLoader("Pobieranie...");

    // Pobieranie warto≈õci dat
    const df = document.getElementById("dateFrom").value;
    const dt = document.getElementById("dateTo").value;
    
    // Pobieranie zaznaczonych checkbox√≥w dla status√≥w i kampanii
    const st = Array.from(document.querySelectorAll('#statusList input:checked')).map(cb => cb.value).join(",");
    const cp = Array.from(document.querySelectorAll('#campList input:checked')).map(cb => cb.value).join(",");

    // Opcjonalnie: aktualizacja tekstu na przyciskach dropdown√≥w
    document.getElementById("statusBtnText").innerText = st ? "üìå Wybrano: " + st.split(",").length : "üìå Statusy";
    document.getElementById("campBtnText").innerText = cp ? "üì¢ Wybrano: " + cp.split(",").length : "üì¢ Kampanie";

    const url = `${API_URL}?action=list&token=${token}&limit=50&offset=${dashboardOffset}&sort=${dashboardSort}&dateFrom=${df}&dateTo=${dt}&status=${encodeURIComponent(st)}&campaigns=${encodeURIComponent(cp)}`;

    fetch(url)
        .then(r => r.json())
        .then(d => {
            hideLoader();
            if (!d.success) return;
            currentTotal = d.total; 
            d.rows.forEach(r => allLeadsMap.set(String(r.id), r));
            dashboardOffset += d.rows.length;
            displayTable();
            document.getElementById("loadMoreBtn").style.display = (allLeadsMap.size < currentTotal) ? "block" : "none";
        })
        .catch(() => { hideLoader(); alert("B≈ÇƒÖd po≈ÇƒÖczenia."); });
}

        function displayTable() {
            const list = Array.from(allLeadsMap.values());
            const html = list.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td>${formatDate(r.created)}</td>
                    <td><strong>${r.name || "-"}</strong><br><small class="muted">üìû ${formatPhone(r.phone)}</small><br><small class="muted">‚úâÔ∏è ${r.email || "-"}</small></td>
                    <td><span class="status-badge ${statusClass(r.status)}">${r.status}</span></td>
                    <td>${formatDate(r.updated)}</td>
                    <td>${r.wait_time_combined || "-"}</td>
                    <td>${r.campaign || "-"}</td>
                    <td style="text-align:center;"><button class="btn-tool" onclick="openPreview('${r.id}')">Szczeg√≥≈Çy</button></td>
                </tr>
            `).join("");
            document.getElementById("tableBody").innerHTML = html;
        }

        function toggleSort() {
            dashboardSort = (dashboardSort === "desc") ? "asc" : "desc";
            const btn = document.getElementById("sortBtn");
            if (btn) {
                btn.innerText = (dashboardSort === "desc") ? "üìÖ Najnowsze" : "üìÖ Najstarsze";
            }
            loadDashboard(true);
        }

        function clearFilters() {
            document.getElementById("dateFrom").value = "";
            document.getElementById("dateTo").value = "";
            document.querySelectorAll('.multiselect-content input').forEach(cb => cb.checked = false);
            loadDashboard(true);
        }

        function openPreview(id) {
            const r = allLeadsMap.get(String(id));
            if(!r) return;
            document.getElementById("previewContent").innerHTML = `
                <div class="box">
                    <p>üÜî <strong>ID:</strong> ${r.id}</p>
                    <p>üìÖ <strong>Zg≈Çoszenie:</strong> ${formatDate(r.created)}</p>
                    <p>üì¢ <strong>Kampania:</strong> ${r.campaign || "-"}</p>
                </div>
                <div class="box data">
                    <p><strong>üßæ Pacjent:</strong> ${r.name}</p>
                    <p><strong>üìû Telefon:</strong> ${formatPhone(r.phone)}</p>
                    <p><strong>‚úâÔ∏è ${r.email || "-"}</strong></p>
                    <p><strong>‚è±Ô∏è Czas kontaktu (realny):</strong> ${r.wait_time_combined}</p>
                    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                    <p><strong>ü¶∑ Info 1:</strong> ${r.info1 || "-"}</p>
                    <p><strong>üìù Info 2:</strong> ${r.info2 || "-"}</p>
                </div>`;
            document.getElementById("previewModal").classList.remove("hidden");
        }

        function closePreview() { document.getElementById("previewModal").classList.add("hidden"); }

        function handleStatusClick(newS) {
            if (currentLeadStatus === "nowy") {
                updateStatus(newS);
            } else {
                const msg = `Zmieniƒá status z <b>${currentLeadStatus.toUpperCase()}</b> na <b>${newS.toUpperCase()}</b>?`;
                document.getElementById("confirmMsg").innerHTML = msg;
                document.getElementById("confirmModal").classList.remove("hidden");
                document.getElementById("confirmYes").onclick = () => {
                    document.getElementById("confirmModal").classList.add("hidden");
                    updateStatus(newS);
                };
                document.getElementById("confirmNo").onclick = () => document.getElementById("confirmModal").classList.add("hidden");
            }
        }

        async function updateStatus(s) {
            showLoader("Zapisywanie...");
            const controller = new AbortController();
            const tid = setTimeout(() => controller.abort(), 10000);

            try {
                const res = await fetch(API_URL, { 
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: 'update', row: row, token: token, status: s }),
                    signal: controller.signal
                });
                const d = await res.json();
                if (d.success) {
                    app.innerHTML = `<div class="content" style="text-align:center; padding:50px;"><h2>‚úÖ Zapisano</h2><button class="btn-tool" onclick="location.reload()" style="margin:20px auto;">Wr√≥ƒá</button></div>`;
                } else {
                    alert("B≈ÇƒÖd: " + d.error);
                    location.reload();
                }
            } catch (e) { alert("B≈ÇƒÖd po≈ÇƒÖczenia."); } 
            finally { hideLoader(); clearTimeout(tid); }
        }

        function statusClass(s) {
            const status = String(s || "").toLowerCase();
            if (status === "odrzucony") return "s-odrzucony";
            if (status.includes("porzucony")) return "s-porzucony";
            if (status.includes("nie") && status.includes("odbiera")) return "s-nie_odbiera";
            if (status.includes("obs") || status === "obs≈Çu≈ºony") return "s-obsluzony";
            return "s-nowy";
        }

        function formatPhone(p) {
            if (!p) return "-";
            let d = p.toString().replace(/\D/g, "");
            if (d.startsWith("48") && d.length === 11) d = d.slice(2);
            return d.length === 9 ? `+48 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}` : p;
        }

        function showLoader(t) { 
            document.getElementById("loader").querySelector(".loader-text").textContent = t; 
            document.getElementById("loader").classList.remove("hidden"); 
        }
        function hideLoader() { document.getElementById("loader").classList.add("hidden"); }
        function showError(m) { app.innerHTML = `<div class="content"><h3>‚õî B≈ÇƒÖd</h3><p>${m}</p></div>`; }

        window.onload = () => {
            if (action === "list") {
                renderListLayout();
                loadDashboard(true);
            } else if (row && token) {
                loadSingle();
            } else {
                showError("Brak wymaganych parametr√≥w linku.");
            }
        };

        function formatDate(dateStr) { 
            if (!dateStr || dateStr === "-") return "-";
            
            // Zak≈Çadamy, ≈ºe dateStr to "RRRR-MM-DD HH:mm:ss" lub ISO
            // Zamieniamy na format: DD.MM.RRRR HH:mm
            try {
                const parts = dateStr.split(' ');
                const datePart = parts[0]; // RRRR-MM-DD
                const timePart = parts[1] ? parts[1].substring(0, 5) : ""; // HH:mm
                
                const d = datePart.split('-');
                if (d.length !== 3) return dateStr; // Zwr√≥ƒá orygina≈Ç je≈õli format jest inny
                
                return `${d[2]}.${d[1]}.${d[0]} ${timePart}`;
            } catch (e) {
                return dateStr;
            }
        }
    </script>
</body>
</html>
