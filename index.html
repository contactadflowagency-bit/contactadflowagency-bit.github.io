<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Status leada</title>

<style>
body {
  font-family: 'Segoe UI', Roboto, Arial, sans-serif;
  background:#f7f8fa;
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.wrapper {
  max-width:600px;
  width:90%;
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  overflow:hidden;
}

.header {
  background: linear-gradient(135deg, #00bcd4, #9c27b0);
  color:#fff;
  padding:24px;
  text-align:center;
}

.header img {
  width:70px;
  border-radius:16px;
  display:block;
  margin:0 auto 10px;
}

.header h2 {
  margin:0;
  font-size:22px;
}

.content {
  padding:26px 30px;
}

.box {
  background:#f4fbfd;
  border-left:4px solid #00bcd4;
  padding:16px 20px;
  border-radius:6px;
  margin-bottom:20px;
}

.box.data {
  background:#f0faff;
}

.box.script {
  background:#f9f9f9;
  border:1px dashed #ccc;
  font-size:14px;
  color:#555;
}

p {
  margin:6px 0;
  font-size:15px;
}

.meta {
  color:#555;
}

.buttons {
  text-align:center;
  margin:30px 0;
}

.buttons a {
  display:inline-block;
  margin:6px;
  padding:12px 20px;
  border-radius:6px;
  color:white;
  text-decoration:none;
  font-weight:bold;
  cursor: pointer;
}

.obs { background:#4caf50; }
.nie { background:#ff9800; }
.odrz { background:#f44336; }

.footer {
  background:#f7f8fa;
  text-align:center;
  padding:14px;
  font-size:12px;
  color:#999;
}
</style>
<style>
  .status-badge {
    display:inline-block;
    padding:6px 12px;
    border-radius:999px;
    font-weight:700;
    font-size:14px;
    color:#fff;
  }
  .s-nowy { background:#9c27b0; }
  .s-w_kontakcie { background:#2196f3; }
  .s-nie_odbiera { background:#ff9800; }
  .s-obsluzony { background:#4caf50; }
  .s-odrzucony { background:#f44336; }
  
  .status-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:10px;
  }
  
  .muted {
    font-size:13px;
    color:#777;
  }
  
  .disabled {
    opacity:.4;
    pointer-events: none;
    cursor: default;
    filter: grayscale(40%);
  }
  
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  
  .modal.hidden {
    display: none;
    pointer-events: none;
  }
  
  .modal-box {
    background: #fff;
    padding: 22px;
    border-radius: 12px;
    width: 90%;
    max-width: 360px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
  }
  
  .modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }
  
  .modal-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  
  button.cancel {
    background: #eee;
  }
  
  button.confirm {
    background: #4caf50;
    color: white;
  }
  
  /* ===== DASHBOARD â€“ SZEROKI WIDOK ===== */
  /* ===== DASHBOARD â€“ SZEROKI WIDOK (ZAKTUALIZOWANY) ===== */
  .dashboard-wide { max-width: 1400px !important; }

  body.dashboard-mode { display: block; }
  
  body.dashboard-mode .wrapper {
    max-width: 1400px;
    width: 95%;
    margin: 20px auto;
    min-height: auto;
  }

  /* Kontener dla tabeli z przewijaniem bocznym na mobile */
  .table-scroll {
    width: 100%;
    overflow-x: auto;
    border: 1px solid #eee;
    border-radius: 8px;
  }

  .dashboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    min-width: 1000px; /* Zapobiega Å›ciskaniu kolumn na maÅ‚ych ekranach */
  }
  
  .dashboard-table thead th {
    background: #f4f7fb;
    padding: 12px 10px;
    text-align: left;
    font-weight: 700;
    border-bottom: 2px solid #e3e7ee;
    cursor: pointer;
  }
  
  .dashboard-table tbody td {
    padding: 12px 10px;
    border-bottom: 1px solid #eee;
  }

  /* Responsywny Toolbar */
  .dashboard-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
  }

  .dashboard-toolbar input, .dashboard-toolbar select {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 14px;
  }

  @media (max-width: 800px) {
    .dashboard-toolbar { flex-direction: column; align-items: stretch; }
    .dashboard-toolbar input { width: 100%; }
    .dashboard-toolbar div { justify-content: space-between; display: flex; }
  }
  
</style>
</head>

<body>

<div class="wrapper" id="app">
  <div class="content">
    â³ ÅÄ…czenie z serweremâ€¦
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzBLTLdMX1DXfLdDjiIit97OWNNaIjdiXqj9_bVtWSdytJAy4x9SvRTZdSP8t3Ysd-7/exec";
const params = new URLSearchParams(window.location.search);
const row = params.get("row");
const token = params.get("token");
const app = document.getElementById("app");
let offset = 0;
const LIMIT = 30;
let allRows = [];
let totalLeads = 0;

function formatDate(iso) {
  if (!iso) return "-";
  const d = new Date(iso);
  return d.toLocaleString("pl-PL", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function showError(msg) {
  app.classList.add("dashboard-wide");

  app.innerHTML = `
    <div class="content">
      <h3>â›” BÅ‚Ä…d</h3>
      <p style="color:#777">${msg}</p>
    </div>
  `;
}
  
function statusClass(status) {
  return {
    "nowy": "s-nowy",
    "w_kontakcie": "s-w_kontakcie",
    "nie_odbiera": "s-nie_odbiera",
    "obsluzony": "s-obsluzony",
    "odrzucony": "s-odrzucony"
  }[status] || "s-nowy";
}

function canEdit(lastUpdate, status) {
  const normalized = (status || "").trim().toLowerCase();

  // ZAWSZE edytowalne
  if (normalized === "" || normalized === "nowy" || normalized === "nie_odbiera") {
    return true;
  }

  // Dla pozostaÅ‚ych â€” limit 15 minut
  if (!lastUpdate) return true;

  const diffMin = (Date.now() - new Date(lastUpdate)) / 1000 / 60;
  return diffMin <= 15;
}
  
function render(lead) {
  const status = lead["Obecny status"] || "nowy";
  const lastUpdate = lead["Data ostatniej aktualizacji"];
  const editable = canEdit(lastUpdate, status);
  const isNew = status === "nowy" || status === "";

  app.innerHTML = `
    <div class="header">
      <img src="https://scontent-waw2-2.xx.fbcdn.net/v/t39.30808-6/540904522_122143092902741193_6153063326804191448_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=EXFBb3EdkUsQ7kNvwGb2Smp&_nc_oc=Adngi_kLnbg9pQiId6dkbJxk2TSxZhFWngOi9hCe_Ny49faPOIFTWxxq8fgzzJADO7I&_nc_zt=23&_nc_ht=scontent-waw2-2.xx&_nc_gid=w7niD_O83PtXyVLS5FjwZg&oh=00_AfkKwh5kzI8KNfgAR8NLvYEUObCW-JZmOSS3fx9QybdVYg&oe=6949BD8D" alt="AdFlow">
      <h2>Status kontaktu z pacjentem</h2>
    </div>

    <div class="content">

      <div class="box">
        <div class="status-row">
          <div>
            <p>ğŸ†” <strong>Lead ID:</strong> ${lead["Id."]}</p>
            <p>ğŸ“… <strong>Data zgÅ‚oszenia:</strong> ${formatDate(lead["Data"])}</p>
          </div>
          <div>
            <span class="status-badge ${statusClass(status)}">
              ${status.replace("_"," ").toUpperCase()}
            </span>
            <div class="muted">
              Ostatnia zmiana:<br>
              ${formatDate(lastUpdate)}
            </div>
          </div>
        </div>
      </div>

      <div class="box data">
        <p><strong>ğŸ§¾ ImiÄ™ i nazwisko:</strong> ${lead["ImiÄ™ Nazwisko"]}</p>
        <p><strong>ğŸ“ Telefon:</strong> ${lead["Nr tel"]}</p>
        <p><strong>âœ‰ï¸ Email:</strong> ${lead["Email"] || "-"}</p>
        <p><strong>ğŸ¦· Cel wizyty:</strong> ${lead["Pytanie 1 (cel wizyty)"]}</p>
        <p><strong>ğŸ’¬ Informacje:</strong><br>${lead["Pytanie 2 (Informacje)"] || "-"}</p>
      </div>

      <div class="box script">
        ğŸ’¬ <strong>Sugestia rozmowy:</strong><br>
        â€DzieÅ„ dobry, dzwoniÄ™ z gabinetu stomatologicznego.<br>
        WidzÄ™, Å¼e zgÅ‚osiÅ‚/a siÄ™ Pan/Pani w sprawie
        <strong>${lead["Pytanie 1 (cel wizyty)"]}</strong>.<br>
        Jaki termin wizyty byÅ‚by dla Pana/Pani dogodny?â€
      </div>

      <div class="buttons ${editable ? "" : "disabled"}">
        <a class="obs" onclick="${editable ? `handleStatusClick('obsluzony','${status}')` : ""}">
          âœ” Lead obsÅ‚uÅ¼ony
        </a>
        <a class="nie" onclick="${editable ? `handleStatusClick('nie_odbiera','${status}')` : ""}">
          ğŸ“ Nie odbiera
        </a>
        <a class="odrz" onclick="${editable ? `handleStatusClick('odrzucony','${status}')` : ""}">
          âŒ Lead odrzucony
        </a>
      </div>

      ${
        editable
          ? ""
          : `<p class="muted" style="text-align:center">
               â›” MinÄ…Å‚ limit 15 minut â€” status zablokowany
             </p>`
      }

    </div>

    <div class="footer">
      System AdFlow Â· automatyczna obsÅ‚uga leadÃ³w
    </div>

    <!-- MODAL POTWIERDZENIA -->
    <div id="confirmModal" class="modal hidden">
      <div class="modal-box">
        <h3>ZmieniÄ‡ status?</h3>
        <p>Ten lead byÅ‚ juÅ¼ wczeÅ›niej oznaczony.<br>
        Czy na pewno chcesz zmieniÄ‡ jego status?</p>

        <div class="modal-actions">
          <button class="cancel" onclick="closeModal()">Anuluj</button>
          <button class="confirm" id="confirmBtn">ZmieÅ„ status</button>
        </div>
      </div>
    </div>
  `;
}
  
function confirmUpdate(status) {
  if (!confirm("Czy na pewno chcesz zmieniÄ‡ status leada?")) return;
  updateStatus(status);
}
  
async function updateStatus(status) {
  // ekran Å‚adowania
  app.innerHTML = `
    <div class="content">
      <h3>â³ Zapisywanie statusuâ€¦</h3>
      <p class="muted">ProszÄ™ czekaÄ‡</p>
    </div>
  `;

  try {
    const res = await fetch(
      `${API_URL}?row=${row}&token=${token}&status=${status}`,
      { method: "POST" }
    );

    const data = await res.json();

    if (!data.success) {
      throw new Error(data.error || "BÅ‚Ä…d zapisu");
    }

    // âœ… SUKCES
    app.innerHTML = `
      <div class="content">
        <h3>âœ… Status zostaÅ‚ zapisany</h3>
        <p class="muted">
          Zmiana zostaÅ‚a poprawnie zapisana w systemie
        </p>
      </div>
    `;

  } catch (err) {
    // âŒ BÅÄ„D
    app.innerHTML = `
      <div class="content">
        <h3>â›” Nie udaÅ‚o siÄ™ zapisaÄ‡ statusu. SprÃ³buj odÅ›wieÅ¼yÄ‡ przeglÄ…darkÄ™ i wysÅ‚aÄ‡ jeszcze raz. JeÅ¼eli nie zadziaÅ‚a prosimy o kontakt z Adflow</h3>
        <p class="muted">${err.message}</p>
        <a href="#" onclick="location.reload()" style="
          display:inline-block;
          margin-top:15px;
          font-weight:bold;
        ">
          ğŸ”„ SprÃ³buj ponownie
        </a>
      </div>
    `;
  }
}


let pendingStatus = null;

function handleStatusClick(newStatus, currentStatus) {
  const normalized = (currentStatus || "").trim().toLowerCase();

  // NOWY LEAD â†’ bez potwierdzenia
  if (normalized === "" || normalized === "nowy") {
    updateStatus(newStatus);
    return;
  }

  // STARY LEAD â†’ modal
  pendingStatus = newStatus;
  document.getElementById("confirmModal").classList.remove("hidden");

  document.getElementById("confirmBtn").onclick = () => {
    updateStatus(pendingStatus);
    closeModal();
  };
}

function closeModal() {
  document.getElementById("confirmModal").classList.add("hidden");
  pendingStatus = null;
}

// ===== ROUTER =====
const action = params.get("action");

if (action === "list") {
  loadList();
} else if (row && token) {
  loadSingle();
} else {
  showError("NieprawidÅ‚owy link");
}

// ===== ROUTING FUNKCJE =====

function loadSingle() {
  document.body.classList.remove("dashboard-mode");
  fetch(`${API_URL}?row=${row}&token=${token}`)
    .then(r => r.json())
    .then(d => d.success
      ? render(d.lead)
      : showError("Brak dostÄ™pu do leada")
    )
    .catch(() => showError("BÅ‚Ä…d poÅ‚Ä…czenia z API"));
}

function loadList(reset = true) {
  document.body.classList.add("dashboard-mode");

  if (reset) {
    offset = 0;
    allRows = [];
    app.innerHTML = `
      <div class="content">
        <h3>ğŸ“Š Lista leadÃ³w</h3>
        <p class="muted">Åadowanie danychâ€¦</p>
      </div>
    `;
  }

  fetch(`${API_URL}?action=list&token=${token}&limit=${LIMIT}&offset=${offset}`)
    .then(r => r.json())
    .then(d => {
      if (!d.success) {
        showError("Brak dostÄ™pu do listy leadÃ³w");
        return;
      }

      totalLeads = d.total;
      allRows = allRows.concat(d.rows);
      offset += d.rows.length;

      renderList(allRows);
    })
    .catch(() => showError("BÅ‚Ä…d poÅ‚Ä…czenia z API"));
}

let allRows = [];

function renderList(rows) {
  // DomyÅ›lne sortowanie od najnowszych przy Å‚adowaniu
  allRows = rows.filter(r => r.id).sort((a, b) => new Date(b.created) - new Date(a.created));

  app.innerHTML = `
    <div class="header">
      <h2>ğŸ“Š Dashboard leadÃ³w</h2>
    </div>

    <div class="content">
      <div class="dashboard-toolbar">
        <input type="text" id="searchInput" placeholder="ğŸ” Szukaj..." oninput="filterTable()" style="flex: 1; min-width: 200px;">
        
        <select id="statusFilter" onchange="filterTable()">
          <option value="">â€” Wszystkie statusy â€”</option>
          <option value="nowy">Nowy</option>
          <option value="obsluzony">ObsÅ‚uÅ¼ony</option>
          <option value="nie_odbiera">Nie odbiera</option>
          <option value="odrzucony">Odrzucony</option>
        </select>
      
        <select id="campaignFilter" onchange="filterTable()">
          <option value="">â€” Wszystkie kampanie â€”</option>
        </select>
      
        <div style="display: flex; gap: 5px; align-items: center;">
          <input type="date" id="dateFrom" onchange="filterTable()">
          <span>-</span>
          <input type="date" id="dateTo" onchange="filterTable()">
        </div>
      
        <button onclick="toggleDateSort()" id="sortBtn" title="Sortuj datÄ™" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background: #fff;">ğŸ“… Najnowsze</button>
        <button onclick="clearAllFilters()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer;">ğŸ§¹</button>
      </div>

      <div class="table-scroll">
        <table class="dashboard-table" id="leadTable">
          <thead>
            <tr>
              <th onclick="sortTable('id')">ID</th>
              <th onclick="sortTable('created')">Data zgÅ‚oszenia</th>
              <th onclick="sortTable('name')">Pacjent</th>
              <th onclick="sortTable('status')">Status</th>
              <th onclick="sortTable('updated')">Ost. aktualizacja</th>
              <th>Czas oczekiwania (Realny)</th>
              <th onclick="sortTable('campaign')">Kampania</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div style="text-align:center; margin:20px">
          <button id="loadMoreBtn"
            onclick="loadList(false)"
            style="padding:12px 20px;border-radius:8px;border:1px solid #ccc;cursor:pointer">
            â• ZaÅ‚aduj kolejne 30
          </button>
        </div>
      </div>
    </div>

    <div class="footer">System AdFlow Â· podglÄ…d leadÃ³w</div>
  `;

  renderTableRows(allRows);
  const btn = document.getElementById("loadMoreBtn");
    if (btn) {
      btn.style.display = offset >= totalLeads ? "none" : "inline-block";
    }
  }
  
function renderTableRows(rows) {
  const tbody = document.getElementById("tableBody");
  if (!tbody) return;

  tbody.innerHTML = rows.map(r => {
    // Sprawdzamy czy dane istniejÄ…, jeÅ›li nie, dajemy kreskÄ™
    const wTime = r.wait_time || "-";
    const rTime = r.real_wait_time || "-";
    const waitInfo = `${wTime} (${rTime})`;
    
    return `
      <tr>
        <td>${r.id}</td>
        <td>${formatDate(r.created)}</td>
        <td><strong>${r.name || "-"}</strong><br><small class="muted">${r.phone || ""}</small></td>
        <td>
          <span class="status-badge ${statusClass(r.status)}">
            ${(r.status || "nowy").replace("_"," ").toUpperCase()}
          </span>
        </td>
        <td class="muted">${formatDate(r.updated)}</td>
        <td style="font-size: 13px;">${waitInfo}</td>
        <td>${r.campaign || "-"}</td>
      </tr>
    `;
  }).join("");
}

  function filterTable() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  const statusF = document.getElementById("statusFilter").value;
  const campaignF = document.getElementById("campaignFilter").value;
  const df = document.getElementById("dateFrom").value ? new Date(document.getElementById("dateFrom").value + 'T00:00:00') : null;
  const dt = document.getElementById("dateTo").value ? new Date(document.getElementById("dateTo").value + 'T23:59:59') : null;

  const filtered = allRows.filter(r => {
    // 1. Szukanie tekstowe (ImiÄ™, Tel, Email)
    const matchesQuery = !query || Object.values(r).join(" ").toLowerCase().includes(query);
    
    // 2. Filtr statusu
    const matchesStatus = !statusF || (r.status || "nowy") === statusF;
    
    // 3. Filtr kampanii
    const matchesCampaign = !campaignF || r.campaign === campaignF;
    
    // 4. Filtr dat
    const rDate = r.created ? new Date(r.created) : null;
    const matchesDateFrom = !df || (rDate && rDate >= df);
    const matchesDateTo = !dt || (rDate && rDate <= dt);

    return matchesQuery && matchesStatus && matchesCampaign && matchesDateFrom && matchesDateTo;
  });

  renderTableRows(filtered);
  
  // Aktualizacja licznika
  const counter = document.querySelector(".dashboard-toolbar .muted strong");
  if(counter) counter.innerText = filtered.length;
}

// Funkcja pomocnicza do czyszczenia filtrÃ³w
function clearAllFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("statusFilter").value = "";
  document.getElementById("campaignFilter").value = "";
  document.getElementById("dateFrom").value = "";
  document.getElementById("dateTo").value = "";
  filterTable();
}

// Funkcja do dynamicznego wypeÅ‚niania listy kampanii (wywoÅ‚aj jÄ… po zaÅ‚adowaniu danych)
function populateCampaigns(rows) {
  const select = document.getElementById("campaignFilter");
  if(!select) return;
  const campaigns = [...new Set(rows.map(r => r.campaign).filter(Boolean))].sort();
  select.innerHTML = '<option value="">â€” Wszystkie kampanie â€”</option>' + 
    campaigns.map(c => `<option value="${c}">${c}</option>`).join("");
}

  let sortDir = 1;
let lastSort = null;

function sortTable(key) {
  if (lastSort === key) sortDir *= -1;
  else sortDir = 1;

  lastSort = key;

  const sorted = [...allRows].sort((a, b) => {
    let valA = a[key];
    let valB = b[key];

    // JeÅ›li sortujemy po dacie, zamieÅ„ na obiekt Date dla poprawnego porÃ³wnania
    if (key === 'created' || key === 'updated') {
      valA = new Date(valA || 0);
      valB = new Date(valB || 0);
    } else {
      valA = (valA || "").toString().toLowerCase();
      valB = (valB || "").toString().toLowerCase();
    }

    if (valA < valB) return -1 * sortDir;
    if (valA > valB) return 1 * sortDir;
    return 0;
  });

  renderTableRows(sorted);
}

  let dateSortDesc = true;

function toggleDateSort() {
  dateSortDesc = !dateSortDesc;
  const btn = document.getElementById("sortBtn");
  
  allRows.sort((a, b) => {
    const dateA = new Date(a.created || 0);
    const dateB = new Date(b.created || 0);
    return dateSortDesc ? dateB - dateA : dateA - dateB;
  });

  btn.innerText = dateSortDesc ? "ğŸ“… Najnowsze" : "ğŸ“… Najstarsze";
  filterTable(); // OdÅ›wieÅ¼ widok z uwzglÄ™dnieniem filtrÃ³w
}
</script>

</body>
</html>
