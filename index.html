<!DOCTYPE html>
<html lang="pl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>AdFlow - System Obs≈Çugi Lead√≥w</title>
   <style>
      * { box-sizing: border-box; }
      body { 
         font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
         background:#f7f8fa; 
         margin:0; 
         min-height:100vh; 
         display:flex; 
         justify-content:center; 
         align-items:center;
         padding: 10px;
      }
      .wrapper { 
         max-width:600px; 
         width:100%; 
         background:#fff; 
         border-radius:16px; 
         box-shadow:0 8px 24px rgba(0,0,0,0.12); 
         overflow:hidden; 
      }
      .header { 
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color:#fff; 
         padding:28px 20px; 
         text-align:center; 
         position: relative; 
      }
      .header h2 { 
         margin:0; 
         font-size:22px;
         font-weight:600;
         padding: 0 40px;
      }
      .content { padding:24px; }
      
      /* Nowy styl karty leada */
      .lead-info-card {
         background: #fff;
         border-radius: 12px;
         padding: 0;
         margin-bottom: 16px;
         border: 1px solid #e8eaed;
      }
      
      .lead-info-section {
         padding: 20px;
         border-bottom: 1px solid #f1f3f4;
      }
      
      .lead-info-section:last-child {
         border-bottom: none;
      }
      
      .lead-info-header {
         display: flex;
         justify-content: space-between;
         align-items: flex-start;
         margin-bottom: 20px;
         gap: 12px;
      }
      
      .lead-meta {
         flex: 1;
      }
      
      .lead-id {
         font-size: 13px;
         color: #5f6368;
         font-weight: 500;
         margin-bottom: 4px;
      }
      
      .lead-date {
         font-size: 14px;
         color: #202124;
         font-weight: 500;
      }
      
      .lead-campaign {
         font-size: 13px;
         color: #5f6368;
         margin-top: 4px;
      }
      
      .info-row {
         display: flex;
         align-items: flex-start;
         padding: 12px 0;
         border-bottom: 1px solid #f8f9fa;
      }
      
      .info-row:last-child {
         border-bottom: none;
         padding-bottom: 0;
      }
      
      .info-row:first-child {
         padding-top: 0;
      }
      
      .info-icon {
         font-size: 18px;
         margin-right: 12px;
         min-width: 20px;
      }
      
      .info-content {
         flex: 1;
      }
      
      .info-label {
         font-size: 12px;
         color: #5f6368;
         margin-bottom: 2px;
         font-weight: 500;
         text-transform: uppercase;
         letter-spacing: 0.5px;
      }
      
      .info-value {
         font-size: 15px;
         color: #202124;
         font-weight: 400;
         word-break: break-word;
      }
      
      .info-value.large {
         font-size: 16px;
         font-weight: 500;
      }
      
      .buttons { 
         padding: 20px;
         background: #f8f9fa;
         display: flex;
         flex-direction: column;
         gap: 12px;
      }
      
      .buttons a, .btn-modal, .btn-action { 
         padding: 16px 24px;
         border-radius: 10px;
         color: white;
         text-decoration: none;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s ease;
         border: none;
         font-size: 15px;
         display: flex;
         align-items: center;
         justify-content: center;
         gap: 8px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      .buttons a:hover, .btn-action:hover { 
         transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      .obs { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
      .nie { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
      .odrz { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); }
      .close-btn { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
      
      .status-badge { 
         display: inline-flex;
         align-items: center;
         padding: 8px 16px;
         border-radius: 20px;
         font-weight: 700;
         font-size: 12px;
         color: #fff;
         text-transform: uppercase;
         letter-spacing: 0.5px;
         white-space: nowrap;
         box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .s-nowy { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
      .s-obsluzony { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
      .s-nie_odbiera { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
      .s-odrzucony { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); }
      .s-porzucony { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }
      
      .status-update {
         display: flex;
         flex-direction: column;
         gap: 6px;
         align-items: flex-end;
      }
      
      .update-time {
         font-size: 11px;
         color: #6b7280;
         font-weight: 500;
      }
      
      .disabled { 
         opacity: 0.5;
         pointer-events: none;
      }
      
      .lock-message {
         text-align: center;
         padding: 16px;
         background: #fef2f2;
         border: 2px solid #fecaca;
         border-radius: 10px;
         color: #991b1b;
         font-weight: 600;
         font-size: 14px;
         margin-top: 16px;
      }
      
      /* Dashboard */
      body.dashboard-mode { align-items: flex-start; }
      body.dashboard-mode .wrapper { max-width: 1400px; margin: 20px auto; }
      .dashboard-toolbar { 
         display: flex; 
         flex-wrap: wrap; 
         gap: 10px; 
         margin-bottom: 20px; 
         align-items: center; 
         background: #fff; 
         padding: 15px; 
         border-radius: 12px; 
         border: 1px solid #e8eaed;
         box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .dashboard-toolbar input { 
         padding: 12px; 
         border-radius: 8px; 
         border: 1px solid #ddd; 
         font-size: 14px; 
         outline: none;
         min-height: 44px;
         flex: 1;
         min-width: 120px;
      }
      .date-group {
         display: flex;
         align-items: center;
         gap: 8px;
         flex: 1;
         min-width: 150px;
      }
      .date-group label {
         font-weight: 600;
         font-size: 14px;
         white-space: nowrap;
         margin: 0;
      }
      .date-group input { flex: 1; min-width: 0; }
      .btn-tool { 
         padding: 12px 16px; 
         border-radius: 8px; 
         border: 1px solid #ddd; 
         background: #fff; 
         cursor: pointer; 
         font-weight: 600; 
         display: flex; 
         align-items: center; 
         gap: 5px;
         min-height: 44px;
         font-size: 14px;
         white-space: nowrap;
         transition: all 0.2s;
      }
      .btn-tool:hover {
         background: #f8f9fa;
         border-color: #667eea;
      }
      .btn-apply { 
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
         color: white !important;
         border: none;
      }
      .multiselect { position: relative; flex: 1; min-width: 150px; }
      .multiselect-btn { 
         padding: 12px; 
         border: 1px solid #ddd; 
         border-radius: 8px; 
         background: #fff; 
         cursor: pointer; 
         font-size: 14px; 
         width: 100%;
         display:flex; 
         justify-content: space-between; 
         align-items: center;
         min-height: 44px;
      }
      .multiselect-content { 
         display: none; 
         position: absolute; 
         background: #fff; 
         min-width: 250px; 
         box-shadow: 0 8px 24px rgba(0,0,0,0.15);
         z-index: 100; 
         border: 1px solid #e8eaed;
         border-radius: 12px;
         max-height: 300px; 
         overflow-y: auto; 
         top: 110%; 
         left: 0; 
      }
      .multiselect-content.show { display: block; }
      .multiselect-content label { 
         padding: 12px; 
         display: flex;
         align-items: center;
         cursor: pointer; 
         border-bottom: 1px solid #f1f3f4;
         font-size: 14px; 
         min-height: 44px;
         transition: background 0.2s;
      }
      .multiselect-content label:hover { background: #f8f9fa; }
      .multiselect-content input { margin-right: 10px; }
      
      /* Table */
      .table-scroll { 
         width: 100%; 
         overflow-x: auto; 
         border: 1px solid #e8eaed;
         border-radius: 12px;
         box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .dashboard-table { 
         width: 100%; 
         border-collapse: collapse; 
         font-size: 14px; 
         min-width: 1000px; 
      }
      .dashboard-table thead th { 
         background: #f8f9fa;
         padding: 14px 12px;
         text-align: left; 
         border-bottom: 2px solid #e8eaed;
         font-weight: 600;
         color: #202124;
      }
      .dashboard-table tbody td { 
         padding: 14px 12px;
         border-bottom: 1px solid #f1f3f4;
      }
      .dashboard-table tbody tr:hover {
         background: #f8f9fa;
      }
      .dashboard-table th:last-child, 
      .dashboard-table td:last-child { text-align: center !important; width: 100px; }
      
      /* Card view */
      .card-view { display: none; }
      .lead-card {
         background: #fff;
         border: 1px solid #e8eaed;
         border-radius: 12px;
         padding: 16px;
         margin-bottom: 12px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.08);
         transition: all 0.2s;
      }
      .lead-card:hover {
         box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      }
      .lead-card-header {
         display: flex;
         justify-content: space-between;
         align-items: flex-start;
         margin-bottom: 12px;
         gap: 10px;
      }
      .lead-card-info p { 
         margin: 6px 0;
         font-size: 14px;
         display: flex;
         align-items: center;
         gap: 8px;
      }
      .lead-card-actions {
         margin-top: 12px;
         padding-top: 12px;
         border-top: 1px solid #f1f3f4;
      }
      
      /* Modals */
      .loader { 
         position: fixed; 
         inset: 0; 
         background: rgba(0,0,0,0.65);
         display: flex; 
         align-items: center; 
         justify-content: center; 
         z-index: 9999;
         padding: 20px;
         backdrop-filter: blur(4px);
      }
      .loader.hidden { display: none !important; }
      .loader-box { 
         background: #fff; 
         padding: 32px; 
         border-radius: 16px;
         text-align: center; 
         max-width: 400px; 
         width: 100%; 
         box-shadow: 0 20px 40px rgba(0,0,0,0.3);
         position: relative; 
      }
      .modal-preview-box { 
         max-width: 500px;
         width: 95%; 
         padding: 0; 
         max-height: 90vh;
         overflow-y: auto;
      }
      .modal-close-x { 
         position: absolute; 
         top: 16px;
         right: 16px;
         color: white; 
         font-size: 28px; 
         cursor: pointer; 
         z-index: 10; 
         font-weight: bold;
         width: 40px;
         height: 40px;
         display: flex;
         align-items: center;
         justify-content: center;
         border-radius: 50%;
         background: rgba(0,0,0,0.3);
         transition: all 0.2s;
      }
      .modal-close-x:hover {
         background: rgba(0,0,0,0.5);
         transform: scale(1.1);
      }
      .spinner { 
         width: 48px;
         height: 48px;
         border: 4px solid #e8eaed;
         border-top-color: #667eea;
         border-radius: 50%; 
         animation: spin 0.8s linear infinite; 
         margin: 0 auto 16px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      
      .confirm-modal-content {
         padding: 24px;
      }
      
      .confirm-icon {
         font-size: 48px;
         margin-bottom: 16px;
      }
      
      .confirm-title {
         font-size: 20px;
         font-weight: 600;
         color: #202124;
         margin-bottom: 12px;
      }
      
      .confirm-message {
         font-size: 15px;
         color: #5f6368;
         margin-bottom: 24px;
         line-height: 1.5;
      }
      
      .confirm-buttons {
         display: flex;
         gap: 12px;
      }
      
      .confirm-buttons button {
         flex: 1;
      }
      
      .btn-back {
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 8px 16px;
          border-radius: 20px;
          background: rgba(255, 255, 255, 0.2);
          color: #fff;
          border: 1px solid rgba(255, 255, 255, 0.3);
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          backdrop-filter: blur(8px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          transition: all 0.2s ease;
          min-height: 36px;
      }
      .btn-back::before { content: "‚Üê"; font-size: 16px; }
      .btn-back:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateY(-50%) translateX(-2px);
      }

      /* Mobile */
      @media (max-width: 768px) {
         body { padding: 5px; }
         body.dashboard-mode { padding: 10px; }
         .wrapper { border-radius: 12px; margin: 10px 0; }
         .header { padding: 24px 16px; }
         .header h2 { font-size: 18px; padding: 0 35px; }
         .content { padding: 16px; }
         .lead-info-section { padding: 16px; }
         .buttons { padding: 16px; }
         .buttons { flex-direction: column; gap: 10px; }
         .dashboard-toolbar { padding: 12px; gap: 8px; }
         .date-group { width: 100%; }
         .date-group label { min-width: 35px; }
         .multiselect { width: 100%; }
         .multiselect-content { width: calc(100vw - 60px); left: 50%; transform: translateX(-50%); }
         .btn-tool { width: 100%; justify-content: center; }
         .table-scroll { display: none; }
         .card-view { display: block; }
         .btn-back { padding: 6px 12px; font-size: 13px; left: 10px; }
         .btn-back span { display: none; }
         .modal-preview-box { width: 98%; max-height: 95vh; }
         .modal-close-x { width: 36px; height: 36px; font-size: 24px; }
      }
      
      @media (max-width: 480px) {
         .header h2 { font-size: 16px; }
         .status-badge { font-size: 11px; padding: 6px 12px; }
         .lead-card { padding: 12px; }
      }

      .status-buttons .btn-action {
          opacity: 0.6;
          filter: grayscale(20%);
      }
      
      .status-buttons .btn-action.active {
          opacity: 1;
          filter: none;
          box-shadow: 0 6px 16px rgba(0,0,0,0.25);
          transform: scale(1.02);
      }

      #previewModal .lead-info-card,
      #previewModal .lead-info-section,
      #previewModal .info-row {
          text-align: left;
      }
      
      #previewModal .lead-info-header {
          align-items: flex-start;
      }
   </style>
</head>
<body>
   <div class="wrapper" id="app">
      <div class="content" style="text-align:center;">‚è≥ ≈ÅƒÖczenie z serwerem...</div>
   </div>
   
   <div id="loader" class="loader hidden">
      <div class="loader-box">
         <div class="spinner"></div>
         <div class="loader-text">≈Åadowanie...</div>
      </div>
   </div>
   
   <div id="confirmModal" class="loader hidden">
      <div class="loader-box">
         <div class="confirm-modal-content">
            <div class="confirm-icon">‚ö†Ô∏è</div>
            <div class="confirm-title">Potwierd≈∫ zmianƒô statusu</div>
            <div class="confirm-message" id="confirmMsg"></div>
            <div class="confirm-buttons">
               <button class="btn-modal obs" id="confirmYes">‚úì Potwierd≈∫</button>
               <button class="btn-modal close-btn" id="confirmNo">‚úï Anuluj</button>
            </div>
         </div>
      </div>
   </div>
   
   <div id="previewModal" class="loader hidden" onclick="closePreview(event)">
      <div class="loader-box modal-preview-box" onclick="event.stopPropagation()">
         <div class="header">
            <h2>Szczeg√≥≈Çy leada</h2>
         </div>
         <div id="previewContent"></div>
      </div>
   </div>
   
   <script>
      // ====== BEZPIECZE≈ÉSTWO - XSS PROTECTION ======
      function escapeHtml(text) {
          if (!text) return '-';
          const div = document.createElement('div');
          div.textContent = String(text);
          return div.innerHTML;
      }
         
      const API_URL = "https://script.google.com/macros/s/AKfycbzKRhMb-C2ZXgMuDdn9tPNpKez9WpxtzPYsi1r_hU_uF8ZZuJBNJkcEJm5Epg43elll/exec";
      
      const params = new URLSearchParams(window.location.search);
      const row = params.get("row");
      const token = params.get("token");
      const key = params.get("key");
      
      let allLeadsMap = new Map();
      let currentTotal = 0;
      let dashboardOffset = 0;
      let dashboardSort = "desc";
      let currentLeadStatus = "nowy";
      
      // ====== API ======
      async function apiCall(body) {
        if (!key) throw new Error("Brak klucza dostƒôpu");
        
        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({ key, ...body })
          });
          const data = await res.json();
          
          if (!data.success && data.error && data.error.includes('Za du≈ºo zapyta≈Ñ')) {
            showError('‚è±Ô∏è Za du≈ºo zapyta≈Ñ. Odczekaj chwilƒô i spr√≥buj ponownie.');
            return null;
          }
          
          return data;
        } catch (err) {
          throw new Error("B≈ÇƒÖd po≈ÇƒÖczenia: " + err.message);
        }
      }
      
      // ====== SINGLE LEAD ======
      async function loadSingle() {
          document.body.classList.remove("dashboard-mode");
          showLoader("Pobieranie...");
          
          try {
              const d = await apiCall({ action: 'single', row, token });
              hideLoader();
              if (!d) return;
              if(d.success) {
                  currentLeadStatus = String(d.lead.statusKey || "nowy");
                  renderSingle(d.lead);
              } else {
                  showError("B≈ÇƒÖd: " + (d.error || "Brak dostƒôpu"));
              }
          } catch(err) {
              hideLoader();
              showError("B≈ÇƒÖd po≈ÇƒÖczenia: " + err.message);
          }
      }
      
      function renderSingle(lead) {
          app.innerHTML = `
              <div class="header">
                  <button class="btn-back" onclick="goToDashboard()"><span>Dashboard</span></button>
                  <h2>Status kontaktu</h2>
              </div>
              <div class="content">
                  <div class="lead-info-card">
                      <div class="lead-info-section">
                          <div class="lead-info-header">
                              <div class="lead-meta">
                                  <div class="lead-id">üÜî ID: ${escapeHtml(lead.id)}</div>
                                  <div class="lead-date">üìÖ ${formatDate(lead.date)}</div>
                                  <div class="lead-campaign">üì¢ ${escapeHtml(lead.campaign)}</div>
                              </div>
                              <div class="status-update">
                                  <span class="status-badge ${statusClass(lead.statusKey)}">${escapeHtml(lead.status)}</span>
                                  <div class="update-time">${formatDate(lead.lastUpdate)}</div>
                              </div>
                          </div>
                      </div>
                      
                      <div class="lead-info-section">
                          <div class="info-row">
                              <div class="info-icon">üë§</div>
                              <div class="info-content">
                                  <div class="info-label">Pacjent</div>
                                  <div class="info-value large">${escapeHtml(lead.name)}</div>
                              </div>
                          </div>
                          
                          <div class="info-row">
                              <div class="info-icon">üìû</div>
                              <div class="info-content">
                                  <div class="info-label">Telefon</div>
                                  <div class="info-value">${formatPhone(lead.phone)}</div>
                              </div>
                          </div>
                          
                          <div class="info-row">
                              <div class="info-icon">‚úâÔ∏è</div>
                              <div class="info-content">
                                  <div class="info-label">Email</div>
                                  <div class="info-value">${escapeHtml(lead.email)}</div>
                              </div>
                          </div>
                          
                          <div class="info-row">
                              <div class="info-icon">‚è±Ô∏è</div>
                              <div class="info-content">
                                  <div class="info-label">Czas reakcji</div>
                                  <div class="info-value">${calculateWaitTimes(lead.date, lead.lastUpdate, lead.waitUntil, lead.statusKey)}</div>
                              </div>
                          </div>
                      </div>
                      
                      <div class="lead-info-section">
                          <div class="info-row">
                              <div class="info-icon">ü¶∑</div>
                              <div class="info-content">
                                  <div class="info-label">Cel wizyty</div>
                                  <div class="info-value">${escapeHtml(lead.info1)}</div>
                              </div>
                          </div>
                          
                          <div class="info-row">
                              <div class="info-icon">üìù</div>
                              <div class="info-content">
                                  <div class="info-label">Dodatkowe informacje</div>
                                  <div class="info-value">${escapeHtml(lead.info2)}</div>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="buttons status-buttons ${lead.canEdit ? "" : "disabled"}">
                     <a class="obs btn-action ${lead.statusKey === 'obsluzony' ? 'active' : ''}" onclick="handleStatusClick('obsluzony')">
                        ‚úîÔ∏è Obs≈Çu≈ºony
                     </a>
                     
                     <a class="nie btn-action ${lead.statusKey === 'nie_odbiera' ? 'active' : ''}" onclick="handleStatusClick('nie_odbiera')">
                        üìû Nie odbiera
                     </a>
                     
                     <a class="odrz btn-action ${lead.statusKey === 'odrzucony' ? 'active' : ''}" onclick="handleStatusClick('odrzucony')">
                        ‚úñÔ∏è Odrzucony
                     </a>
                  </div>
                  
                  ${!lead.canEdit ? '<div class="lock-message">üîí Edycja zablokowana</div>' : ''}
              </div>
          `;
      }
      
      // ====== DASHBOARD ======
      function renderListLayout() {
          document.body.classList.add("dashboard-mode");
          app.innerHTML = `
              <div class="header">
                  <h2>üìä Dashboard lead√≥w</h2>
              </div>
              <div class="content">
                  <div class="dashboard-toolbar">
                      <div class="multiselect">
                          <div class="multiselect-btn" onclick="toggleDropdown('statusList')">
                              <span>üìå Statusy</span><span>‚ñº</span>
                          </div>
                          <div class="multiselect-content" id="statusList">
                              <label><input type="checkbox" value="nowy"> Nowy</label>
                              <label><input type="checkbox" value="obsluzony"> Obs≈Çu≈ºony</label>
                              <label><input type="checkbox" value="nie_odbiera"> Nie odbiera</label>
                              <label><input type="checkbox" value="odrzucony"> Odrzucony</label>
                              <label><input type="checkbox" value="porzucony"> Porzucony</label>
                          </div>
                      </div>
                  
                      <div class="multiselect">
                          <div class="multiselect-btn" onclick="toggleDropdown('campList')">
                              <span>üì¢ Kampanie</span><span>‚ñº</span>
                          </div>
                          <div class="multiselect-content" id="campList">
                              <div style="padding:10px; color:#888;">≈Åadowanie...</div>
                          </div>
                      </div>
                      
                      <div class="date-group">
                          <label for="dateFrom">Od:</label>
                          <input type="date" id="dateFrom">
                      </div>
                      <div class="date-group">
                          <label for="dateTo">Do:</label>
                          <input type="date" id="dateTo">
                      </div>
                      
                      <button onclick="loadDashboard(true)" class="btn-tool btn-apply">üîç Zastosuj</button>
                      <button onclick="toggleSort()" id="sortBtn" class="btn-tool">üìÖ Najnowsze</button>
                      <button onclick="clearFilters()" class="btn-tool">üßπ Wyczy≈õƒá</button>
                  </div>
      
                  <div class="table-scroll">
                      <table class="dashboard-table">
                          <thead>
                              <tr>
                                  <th>ID</th><th>Data</th><th>Pacjent</th><th>Status</th><th>Aktualizacja</th><th>Czas</th><th>Kampania</th><th>Akcja</th>
                              </tr>
                          </thead>
                          <tbody id="tableBody"></tbody>
                      </table>
                  </div>
                  
                  <div class="card-view" id="cardView"></div>
                  
                  <div style="text-align:center; padding:20px;">
                      <button id="loadMoreBtn" onclick="loadDashboard(false)" class="btn-tool" style="display:none;">Za≈Çaduj wiƒôcej</button>
                  </div>
              </div>
          `;
          fetchCampaigns();
      }
      
      function toggleDropdown(id) {
          const el = document.getElementById(id);
          const isShow = el.classList.contains("show");
          document.querySelectorAll('.multiselect-content').forEach(c => c.classList.remove('show'));
          if(!isShow) el.classList.add("show");
      }
      
      async function fetchCampaigns() {
          try {
              const d = await apiCall({ action: 'campaigns' });
              if (!d) return;
              const c = document.getElementById("campList");
              c.innerHTML = (d.success && d.campaigns) 
                  ? d.campaigns.map(name => `<label><input type="checkbox" value="${escapeHtml(name)}"> ${escapeHtml(name)}</label>`).join("")
                  : '<div style="padding:10px; color:#888;">Brak kampanii</div>';
          } catch(err) {
              document.getElementById("campList").innerHTML = '<div style="padding:10px; color:#f44;">B≈ÇƒÖd</div>';
          }
      }
      
      async function loadDashboard(reset = true) {
          if (reset) {
              dashboardOffset = 0;
              allLeadsMap.clear();
              document.getElementById("tableBody").innerHTML = "";
              document.getElementById("cardView").innerHTML = "";
          }
          showLoader("Pobieranie...");
      
          try {
              const d = await apiCall({
                  action: 'list',
                  limit: 50,
                  offset: dashboardOffset,
                  sort: dashboardSort,
                  dateFrom: document.getElementById("dateFrom").value,
                  dateTo: document.getElementById("dateTo").value,
                  status: Array.from(document.querySelectorAll('#statusList input:checked')).map(cb => cb.value).join(","),
                  campaigns: Array.from(document.querySelectorAll('#campList input:checked')).map(cb => cb.value).join(",")
              });
              
              hideLoader();
              if (!d) return;
              if (!d.success) return alert("B≈ÇƒÖd: " + (d.error || "Nieznany"));
              
              currentTotal = d.total; 
              d.rows.forEach(r => allLeadsMap.set(String(r.id), r));
              dashboardOffset += d.rows.length;
              displayData();
              document.getElementById("loadMoreBtn").style.display = (allLeadsMap.size < currentTotal) ? "block" : "none";
          } catch(err) {
              hideLoader();
              alert("B≈ÇƒÖd: " + err.message);
          }
      }
      
      function displayData() {
          let list = Array.from(allLeadsMap.values()).sort((a, b) => {
              const diff = parseInt(b.id) - parseInt(a.id);
              return dashboardSort === "desc" ? diff : -diff;
          });
      
          // Table
          document.getElementById("tableBody").innerHTML = list.map(r => `
              <tr>
                  <td>${escapeHtml(r.id)}</td>
                  <td>${formatDate(r.created)}</td>
                  <td>
                      <strong>${escapeHtml(r.name)}</strong><br>
                      <small style="color:#6b7280;">üìû ${formatPhone(r.phone)}</small><br>
                      <small style="color:#6b7280;">‚úâÔ∏è ${escapeHtml(r.email)}</small>
                  </td>
                  <td><span class="status-badge ${statusClass(r.status)}">${escapeHtml(r.status)}</span></td>
                  <td>${formatDate(r.updated)}</td>
                  <td>${calculateWaitTimes(r.created, r.updated, r.waitUntil, r.status)}</td>
                  <td>${escapeHtml(r.campaign)}</td>
                  <td><button class="btn-tool" onclick="openPreview('${escapeHtml(r.id)}')">üëÅÔ∏è</button></td>
              </tr>
          `).join("");
          
          // Cards
          document.getElementById("cardView").innerHTML = list.map(r => `
              <div class="lead-card">
                  <div class="lead-card-header">
                      <div style="flex: 1;">
                          <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">üÜî ${escapeHtml(r.id)}</div>
                          <div style="color:#6b7280; font-size:13px;">üìÖ ${formatDate(r.created)}</div>
                      </div>
                      <span class="status-badge ${statusClass(r.status)}">${escapeHtml(r.status)}</span>
                  </div>
                  <div class="lead-card-info">
                     <p>üë§ <strong>${escapeHtml(r.name)}</strong></p>
                     <p>üìû ${formatPhone(r.phone)}</p>
                     <p>‚úâÔ∏è ${escapeHtml(r.email)}</p>
                     <p>üì¢ ${escapeHtml(r.campaign)}</p>
                     <p>‚è±Ô∏è ${calculateWaitTimes(r.created, r.updated, r.waitUntil, r.status)}</p>
                  </div>
                  <div class="lead-card-actions">
                      <button class="btn-tool" onclick="openPreview('${escapeHtml(r.id)}')" style="width: 100%;">üëÅÔ∏è Szczeg√≥≈Çy</button>
                  </div>
              </div>
          `).join("");
      }
      
      function toggleSort() {
          dashboardSort = dashboardSort === "desc" ? "asc" : "desc";
          document.getElementById("sortBtn").innerText = dashboardSort === "desc" ? "üìÖ Najnowsze" : "üìÖ Najstarsze";
          loadDashboard(true);
      }
      
      function clearFilters() {
          document.getElementById("dateFrom").value = "";
          document.getElementById("dateTo").value = "";
          document.querySelectorAll('.multiselect-content input').forEach(cb => cb.checked = false);
          loadDashboard(true);
      }
      
      function openPreview(id) {
          const r = allLeadsMap.get(String(id));
          if(!r) return;
      
          document.getElementById("previewContent").innerHTML = `
              <div class="lead-info-card" style="border:none; box-shadow:none;">
                <div style="padding:16px 16px 0 16px;">
                    <button class="btn-back" onclick="closePreview()">
                        <span>Powr√≥t</span>
                    </button>
                </div>
                  <div class="lead-info-section">
                      <div class="lead-info-header">
                          <div class="lead-meta">
                              <div class="lead-id">üÜî ID: ${escapeHtml(r.id)}</div>
                              <div class="lead-date">üìÖ ${formatDate(r.created)}</div>
                              <div class="lead-campaign">üì¢ ${escapeHtml(r.campaign)}</div>
                          </div>
                          <div class="status-update">
                              <span class="status-badge ${statusClass(r.status)}">${escapeHtml(r.status)}</span>
                              <div class="update-time">${formatDate(r.updated)}</div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="lead-info-section">
                      <div class="info-row">
                          <div class="info-icon">üë§</div>
                          <div class="info-content">
                              <div class="info-label">Pacjent</div>
                              <div class="info-value large">${escapeHtml(r.name)}</div>
                          </div>
                      </div>
                      
                      <div class="info-row">
                          <div class="info-icon">üìû</div>
                          <div class="info-content">
                              <div class="info-label">Telefon</div>
                              <div class="info-value">${formatPhone(r.phone)}</div>
                          </div>
                      </div>
                      
                      <div class="info-row">
                          <div class="info-icon">‚úâÔ∏è</div>
                          <div class="info-content">
                              <div class="info-label">Email</div>
                              <div class="info-value">${escapeHtml(r.email)}</div>
                          </div>
                      </div>
                      
                      <div class="info-row">
                          <div class="info-icon">‚è±Ô∏è</div>
                          <div class="info-content">
                              <div class="info-label">Czas reakcji</div>
                              <div class="info-value">${calculateWaitTimes(r.created, r.updated, r.waitUntil, r.status)}</div>
                          </div>
                      </div>
                  </div>
                  
                  <div class="lead-info-section">
                      <div class="info-row">
                          <div class="info-icon">ü¶∑</div>
                          <div class="info-content">
                              <div class="info-label">Cel wizyty</div>
                              <div class="info-value">${escapeHtml(r.info1)}</div>
                          </div>
                      </div>
                      
                      <div class="info-row">
                          <div class="info-icon">üìù</div>
                          <div class="info-content">
                              <div class="info-label">Dodatkowe informacje</div>
                              <div class="info-value">${escapeHtml(r.info2)}</div>
                          </div>
                      </div>
                  </div>
              </div>
          `;
          
          document.getElementById("previewModal").classList.remove("hidden");
      }
      
      function closePreview(e) { 
          if (e && e.target !== e.currentTarget) return;
          document.getElementById("previewModal").classList.add("hidden"); 
      }
      
      // ====== STATUS UPDATE ======
      function handleStatusClick(newS) {
          if (currentLeadStatus === "nowy") {
              updateStatus(newS);
          } else {
              const statusNames = {
                  'obsluzony': 'Obs≈Çu≈ºony',
                  'nie_odbiera': 'Nie odbiera', 
                  'odrzucony': 'Odrzucony'
              };
              document.getElementById("confirmMsg").innerHTML = `
                  Czy na pewno chcesz zmieniƒá status<br>
                  z <strong>${statusNames[currentLeadStatus] || currentLeadStatus}</strong><br>
                  na <strong>${statusNames[newS] || newS}</strong>?
              `;
              document.getElementById("confirmModal").classList.remove("hidden");
              document.getElementById("confirmYes").onclick = () => {
                  document.getElementById("confirmModal").classList.add("hidden");
                  updateStatus(newS);
              };
              document.getElementById("confirmNo").onclick = () => {
                  document.getElementById("confirmModal").classList.add("hidden");
              };
          }
      }
      
      async function updateStatus(s) {
          showLoader("Zapisywanie...");
          try {
              const d = await apiCall({ action: 'update', row, token, status: s });
              hideLoader();
              if (!d) return;
              if (d.success) {
                  app.innerHTML = `
                      <div class="content" style="text-align:center; padding:60px 20px;">
                          <div style="font-size:64px; margin-bottom:20px;">‚úÖ</div>
                          <h2 style="color:#10b981; margin:0 0 12px 0;">Status zapisany!</h2>
                          <p style="color:#6b7280; margin-bottom:30px;">Zmiana zosta≈Ça pomy≈õlnie zapisana w systemie.</p>
                          <button class="btn-tool btn-apply" onclick="location.reload()" style="margin:0 auto;">‚Üª Od≈õwie≈º stronƒô</button>
                      </div>
                  `;
              } else {
                  alert("B≈ÇƒÖd: " + d.error);
                  location.reload();
              }
          } catch (e) { 
              hideLoader();
              alert("B≈ÇƒÖd: " + e.message); 
          }
      }
      
      // ====== HELPERS ======
      function statusClass(s) {
          s = String(s || "").toLowerCase();
          if (s.includes("porzu")) return "s-porzucony";
          if (s.includes("odrz")) return "s-odrzucony";
          if (s.includes("nie") && s.includes("odb")) return "s-nie_odbiera";
          if (s.includes("obs")) return "s-obsluzony";
          return "s-nowy";
      }
      
      function formatPhone(p) {
          if (!p) return "-";
          let d = p.toString().replace(/\D/g, "");
          if (d.startsWith("48") && d.length === 11) d = d.slice(2);
          return d.length === 9 ? `+48 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}` : p;
      }
      
      function formatDate(dateStr) { 
          if (!dateStr || dateStr === "-") return "-";
          try {
              const [datePart, timePart] = dateStr.split(' ');
              const [y, m, d] = datePart.split('-');
              return `${d}.${m}.${y} ${timePart ? timePart.substring(0, 5) : ''}`;
          } catch { return dateStr; }
      }
      
      function calculateWaitTimes(createdStr, updatedStr, waitUntilStr, status) {
          if (!createdStr || createdStr === "-") return "-";
      
          const parse = (str) => {
              if (!str || str === "-") return null;
              const [date, time] = str.split(" ");
              const [y, mo, d] = date.split("-");
              const [h, mi] = time ? time.split(":") : [0, 0];
              return new Date(y, mo - 1, d, h, mi);
          };
      
          const created = parse(createdStr);
          const updated = parse(updatedStr);
          const waitUntil = parse(waitUntilStr);
          const now = new Date();
          
          const s = String(status).toLowerCase();
          const isFinished = ['obs', 'nie_odb', 'odrz', 'porzu'].some(x => s.includes(x));
          const end = (isFinished && updated) ? updated : now;
      
          const rawMins = Math.floor((end - created) / 60000);
          let workMins = Math.floor((end - (waitUntil > created ? waitUntil : created)) / 60000);
          if (workMins < 0) workMins = 0;
      
          let color = "#10b981";
          if (workMins > 1440) color = "#dc2626";
          else if (workMins > 120) color = "#ea580c";
          else if (workMins > 30) color = "#f59e0b";
      
          const fmt = (m) => {
              if (m > 2880) return Math.floor(m / 1440) + " dni";
              const h = Math.floor(m / 60);
              return h > 0 ? `${h}h ${m % 60}m` : `${m}m`;
          };
      
          return `<div style="font-weight: 600; color: ${color}; font-size:14px;">${fmt(workMins)}</div><div style="font-size: 12px; color: #9ca3af; margin-top:2px;">(≈ÇƒÖcznie: ${fmt(rawMins)})</div>`;
      }
      
      function goToDashboard() {
          const url = new URL(window.location.href);
          url.searchParams.delete("row");
          url.searchParams.delete("token");
          window.location.href = url.toString();
      }
      
      function showLoader(t) { 
          document.querySelector("#loader .loader-text").textContent = t; 
          document.getElementById("loader").classList.remove("hidden"); 
      }
      
      function hideLoader() { 
          document.getElementById("loader").classList.add("hidden"); 
      }
      
      function showError(m) { 
          app.innerHTML = `
              <div class="content" style="text-align:center; padding:60px 20px;">
                  <div style="font-size:64px; margin-bottom:20px;">‚õî</div>
                  <h2 style="color:#dc2626; margin:0 0 12px 0;">WystƒÖpi≈Ç b≈ÇƒÖd</h2>
                  <p style="color:#6b7280;">${m}</p>
              </div>
          `; 
      }
      
      // ====== INIT ======
      if (row && token) {
          loadSingle();
      } else {
          renderListLayout();
          loadDashboard(true);
      }
   </script>
</body>
</html>
